<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NMC Diagnostic Tool v3.0 ‚Äî Collegio Ematologico</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f5f7fa;
            --surface: #ffffff;
            --surface2: #f0f3f8;
            --border: #d1d9e6;
            --who-color: #2563eb;
            --morfo-color: #059669;
            --mol-color: #d97706;
            --danger: #dc2626;
            --warning: #d97706;
            --success: #059669;
            --text: #1e293b;
            --text-muted: #64748b;
            --text-dim: #475569;
            --discord: #7c3aed;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: #f5f7fa;
            color: var(--text);
            min-height: 100vh;
            font-size: 14px;
        }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 20px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-left h1 {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1.1em;
            font-weight: 600;
            letter-spacing: 0.05em;
            color: var(--text);
        }
        .header-left h1 span { color: var(--who-color); }
        .header-left p {
            color: var(--text-muted);
            font-size: 0.8em;
            margin-top: 2px;
            font-family: 'IBM Plex Mono', monospace;
        }
        .version-chip {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--success);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7em;
            padding: 4px 10px;
            border-radius: 3px;
            letter-spacing: 0.1em;
        }

        /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
        .app-body {
            display: grid;
            grid-template-columns: 380px 1fr;
            min-height: calc(100vh - 65px);
        }

        /* ‚îÄ‚îÄ LEFT PANEL: INPUT ‚îÄ‚îÄ */
        .input-panel {
            background: var(--surface);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            max-height: calc(100vh - 65px);
        }

        .input-section {
            border-bottom: 1px solid var(--border);
            padding: 0 20px 20px 20px;
        }

        .input-section-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.72em;
            font-weight: 700;
            letter-spacing: 0.18em;
            color: #1e293b;
            text-transform: uppercase;
            margin: 0 -20px 16px -20px;
            padding: 10px 20px 10px 16px;
            background: #e8edf5;
            border-left: 4px solid var(--who-color);
        }
        .input-section-title::after {
            display: none;
        }

        .field { margin-bottom: 12px; }
        .field label {
            display: block;
            font-size: 0.78em;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 500;
        }

        select, input[type="number"], input[type="text"], input[type="date"], textarea {
            width: 100%;
            background: #ffffff;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-family: 'IBM Plex Sans', sans-serif;
            transition: border-color 0.2s;
            appearance: none;
        }
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--who-color);
        }
        select option { background: #ffffff; color: #1e293b; }

        textarea { resize: vertical; min-height: 60px; }

        .field-hint {
            font-size: 0.72em;
            color: var(--text-muted);
            margin-top: 3px;
            font-style: italic;
        }
        .field-hint.alert { color: var(--warning); }

        .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .check-field {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            cursor: pointer;
        }
        .check-field input[type="checkbox"] {
            width: 15px; height: 15px;
            accent-color: var(--who-color);
            cursor: pointer;
            flex-shrink: 0;
        }
        .check-field label {
            font-size: 0.82em;
            color: var(--text-dim);
            cursor: pointer;
            margin: 0;
        }

        .mut-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }

        .analyze-btn {
            width: 100%;
            background: var(--who-color);
            color: white;
            border: none;
            padding: 14px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85em;
            font-weight: 600;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            text-transform: uppercase;
        }
        .analyze-btn:hover { background: #2563eb; }
        .analyze-btn:active { transform: scale(0.99); }

        .reset-btn {
            width: 100%;
            background: #fef2f2;
            color: #dc2626;
            border: 2px solid #fca5a5;
            padding: 12px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.82em;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
            margin-top: 8px;
            border-radius: 4px;
            letter-spacing: 0.05em;
        }
        .reset-btn:hover { background: #fee2e2; border-color: #dc2626; }

        .hint-box {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-left: 3px solid var(--who-color);
            padding: 8px 10px;
            font-size: 0.78em;
            color: var(--text-dim);
            margin-bottom: 12px;
            border-radius: 0 3px 3px 0;
        }

        /* ‚îÄ‚îÄ RIGHT PANEL: RESULTS ‚îÄ‚îÄ */
        .results-panel {
            overflow-y: auto;
            max-height: calc(100vh - 65px);
            padding: 24px;
            background: #f5f7fa;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 400px;
            color: var(--text-muted);
            gap: 12px;
        }
        .empty-state .icon { font-size: 3em; opacity: 0.3; }
        .empty-state p { font-family: 'IBM Plex Mono', monospace; font-size: 0.8em; }

        /* ‚îÄ‚îÄ BOARD HEADER ‚îÄ‚îÄ */
        .board-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7em;
            letter-spacing: 0.15em;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 16px;
        }

        /* ‚îÄ‚îÄ TRI-MODAL GRID ‚îÄ‚îÄ */
        .trimodal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1px;
            background: #e2e8f0;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .modal-panel {
            background: var(--surface);
            padding: 20px;
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        .modal-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .modal-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.72em;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            font-weight: 600;
        }

        .who-panel .modal-dot  { background: var(--who-color); }
        .morfo-panel .modal-dot { background: var(--morfo-color); }
        .mol-panel .modal-dot  { background: var(--mol-color); }
        .who-panel .modal-title  { color: var(--who-color); }
        .morfo-panel .modal-title { color: var(--morfo-color); }
        .mol-panel .modal-title  { color: var(--mol-color); }

        /* ‚îÄ‚îÄ DIAGNOSIS CHIPS ‚îÄ‚îÄ */
        .dx-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 16px;
        }

        .dx-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border-radius: 4px;
            background: var(--surface2);
            border: 1px solid var(--border);
        }
        .dx-item.confirmed {
            background: #f0fdf4;
            border-color: #86efac;
        }
        .dx-item.probable {
            background: #fffbeb;
            border-color: #fcd34d;
        }
        .dx-item.excluded {
            opacity: 0.4;
        }

        .dx-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.78em;
            font-weight: 600;
            color: var(--text);
        }
        .dx-status {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65em;
            letter-spacing: 0.08em;
            padding: 2px 6px;
            border-radius: 2px;
        }
        .dx-item.confirmed .dx-status { background: #dcfce7; color: var(--success); }
        .dx-item.probable .dx-status  { background: #fef9c3; color: var(--warning); }
        .dx-item.excluded .dx-status  { background: var(--surface2); color: var(--text-muted); }

        /* ‚îÄ‚îÄ SCORE BAR ‚îÄ‚îÄ */
        .score-bar-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .score-item { }
        .score-item-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: var(--text-dim);
            margin-bottom: 4px;
            font-family: 'IBM Plex Mono', monospace;
        }
        .score-bar-bg {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
        }
        .score-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.6s ease;
        }

        /* ‚îÄ‚îÄ MOL PANEL ‚îÄ‚îÄ */
        .mol-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            margin-bottom: 5px;
            background: var(--surface2);
            border-radius: 3px;
            border: 1px solid var(--border);
            font-size: 0.8em;
        }
        .mol-badge {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 2px;
        }
        .mol-pos { background: #dcfce7; color: var(--success); }
        .mol-neg { background: #f5f7fa; color: var(--text-muted); }
        .mol-partial { background: #fef3c7; color: var(--warning); }

        /* ‚îÄ‚îÄ DISCORDANCE BANNER ‚îÄ‚îÄ */
        .discord-banner {
            background: #faf5ff;
            border: 1px solid #c4b5fd;
            border-radius: 6px;
            padding: 16px 20px;
            margin-bottom: 16px;
        }
        .discord-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .discord-icon { font-size: 1.1em; }
        .discord-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.78em;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: var(--discord);
            text-transform: uppercase;
        }
        .discord-detail {
            font-size: 0.82em;
            color: var(--text-dim);
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .discord-action {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75em;
            color: var(--discord);
            padding: 6px 10px;
            background: #f3e8ff;
            border-radius: 3px;
            display: inline-block;
        }

        /* ‚îÄ‚îÄ RED FLAGS ‚îÄ‚îÄ */
        .redflag-area { margin-bottom: 16px; }
        .redflag-item {
            background: #fef2f2;
            border: 1px solid #fca5a5;
            border-radius: 5px;
            padding: 12px 16px;
            margin-bottom: 8px;
        }
        .redflag-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.78em;
            font-weight: 600;
            color: var(--danger);
            margin-bottom: 4px;
        }
        .redflag-msg { font-size: 0.8em; color: var(--text-dim); }
        .redflag-action {
            font-size: 0.75em;
            color: var(--danger);
            margin-top: 6px;
            font-style: italic;
        }

        /* ‚îÄ‚îÄ CRITERIA DETAIL ‚îÄ‚îÄ */
        .criteria-detail {
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid var(--border);
        }
        .criteria-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65em;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .crit-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.78em;
            color: var(--text-dim);
            line-height: 1.4;
        }
        .crit-icon { flex-shrink: 0; width: 14px; text-align: center; margin-top: 1px; }
        .crit-icon.met     { color: var(--success); }
        .crit-icon.not-met { color: var(--danger); }
        .crit-icon.partial { color: var(--warning); }
        .crit-icon.unknown { color: var(--text-muted); }

        /* ‚îÄ‚îÄ REPORT ‚îÄ‚îÄ */
        .report-section {
            margin-top: 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }
        .report-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .report-header-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.72em;
            letter-spacing: 0.12em;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .copy-btn {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7em;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            transition: border-color 0.2s;
        }
        .copy-btn:hover { border-color: var(--text-muted); color: var(--text); }
        .report-body {
            padding: 16px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.78em;
            white-space: pre-wrap;
            color: var(--text-dim);
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
        }

        /* ‚îÄ‚îÄ MPN-U ‚îÄ‚îÄ */
        .mpnu-banner {
            background: #faf5ff;
            border: 1px solid #ddd6fe;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .mpnu-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8em;
            color: var(--discord);
            font-weight: 600;
            margin-bottom: 10px;
        }
        .mpnu-list { list-style: none; }
        .mpnu-list li {
            font-size: 0.8em;
            color: var(--text-dim);
            padding: 4px 0;
            padding-left: 14px;
            position: relative;
        }
        .mpnu-list li::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: var(--discord);
            font-size: 0.85em;
        }

        /* ‚îÄ‚îÄ ICC WARNING ‚îÄ‚îÄ */
        .icc-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 3px;
            padding: 6px 10px;
            font-size: 0.75em;
            color: var(--warning);
            margin-bottom: 8px;
            width: 100%;
        }

        /* ‚îÄ‚îÄ CELLULARITY HINT ‚îÄ‚îÄ */
        #cellularity-hint {
            font-size: 0.72em;
            color: var(--text-muted);
            margin-top: 4px;
            font-family: 'IBM Plex Mono', monospace;
        }

        /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

        @media (max-width: 900px) {
            .app-body { grid-template-columns: 1fr; }
            .input-panel { max-height: none; border-right: none; border-bottom: 1px solid var(--border); }
            .results-panel { max-height: none; }
            .trimodal-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-left">
        <h1>üî¨ NMC <span>Diagnostic Tool</span></h1>
        <p>Collegio Ematologico Parallelo ‚Äî WHO 2022 ¬∑ Morfologia ¬∑ Clinico-Molecolare</p>
    </div>
    <span class="version-chip">v3.0</span>
</div>

<div class="app-body">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEFT: INPUT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="input-panel">

        <div class="input-section">
            <div class="input-section-title" style="border-color:#6366f1;">Paziente</div>
            <div class="grid2">
                <div class="field">
                    <label>Et√†</label>
                    <input type="number" id="age" min="0" max="120" placeholder="anni">
                </div>
                <div class="field">
                    <label>Sesso</label>
                    <select id="sex">
                        <option value="">--</option>
                        <option value="M">M</option>
                        <option value="F">F</option>
                    </select>
                </div>
            </div>
            <div class="field">
                <label>Quesito clinico</label>
                <input type="text" id="clinical-question" placeholder="es. sospetta ET, escludere PMF">
            </div>
            <div class="field">
                <label>Anno biopsia</label>
                <input type="number" id="biopsy-date" min="2000" max="2100" placeholder="es. 2025">
            </div>
        </div>

        <div class="input-section">
            <div class="input-section-title" style="border-color:#059669;">Istologia</div>

            <!-- 1. CILINDRO -->
            <div class="field">
                <label>Qualit√† campione</label>
                <select id="biopsy-quality">
                    <option value="">--</option>
                    <option value="adequate">Adeguato (‚â•15 mm, ‚â•5 spazi)</option>
                    <option value="suboptimal">Subottimale (10-15 mm o <5 spazi)</option>
                    <option value="inadequate">Inadeguato (<10 mm)</option>
                </select>
            </div>
            <div class="grid2">
                <div class="field">
                    <label>Lunghezza cilindro (mm)</label>
                    <input type="number" id="biopsy-length" min="0" max="60" step="1" placeholder="es. 18">
                </div>
                <div class="field">
                    <label>Spazi midollari (n)</label>
                    <input type="number" id="biopsy-spaces" min="0" max="30" step="1" placeholder="es. 7">
                </div>
            </div>

            <!-- 2. CELLULARIT√Ä GLOBALE -->
            <div class="grid2">
                <div class="field">
                    <label>Cellularit√† (%)</label>
                    <input type="number" id="cellularity-percent" min="0" max="100" step="5" placeholder="es. 80">
                    <div id="cellularity-hint"></div>
                </div>
                <div class="field">
                    <label>Vs et√†</label>
                    <select id="cellularity">
                        <option value="">--</option>
                        <option value="normal">Normale</option>
                        <option value="increased">Aumentata</option>
                        <option value="decreased">Diminuita</option>
                    </select>
                </div>
            </div>

            <!-- 3. RAPPORTO M/E -->
            <div class="field">
                <label>Rapporto M/E</label>
                <select id="me_ratio">
                    <option value="">-- N/V --</option>
                    <option value="normal">Normale (2-4:1)</option>
                    <option value="increased">Aumentato (>4:1)</option>
                    <option value="decreased">Ridotto (&lt;2:1)</option>
                    <option value="inverted">Invertito (&lt;1:1)</option>
                </select>
            </div>

            <!-- 5. LINEA MEGACARIOCITICA -->
            <div class="field">
                <label>Megacariociti ‚Äî morfologia</label>
                <select id="megakaryocyte">
                    <option value="">--</option>
                    <option value="normal">Normali</option>
                    <option value="hyperlobulated">Iperlobulati maturi (quadro ET)</option>
                    <option value="clustered">Clustering + atipia (quadro PMF)</option>
                    <option value="pleomorphic">Pleomorfi varie taglie (quadro PV)</option>
                </select>
            </div>

            <!-- 6. LINEA GRANULOCITARIA (pattern proliferativo) -->
            <div class="field">
                <label>Proliferazione midollare (pattern dominante)</label>
                <select id="proliferation">
                    <option value="">--</option>
                    <option value="minimal">Minima/Normale</option>
                    <option value="megakaryocytic">Megacariocitica</option>
                    <option value="granulocytic">Granulocitaria</option>
                    <option value="panmyelosis">Panmielosi (E+G+M)</option>
                    <option value="erythroid">Eritroide</option>
                </select>
            </div>

            <!-- 7. LINEA ERITROIDE (E-caderina qui, non nell'IHC) -->
            <div class="field">
                <label>E-caderina ‚Äî linea eritroide</label>
                <select id="ecadherin">
                    <option value="">-- N/E --</option>
                    <option value="increased">Aumentata (eritropoiesi accelerata)</option>
                    <option value="focal">Focale (normale)</option>
                    <option value="negative">Negativa/assente</option>
                    <option value="absent">Ridotta (eritropoiesi inefficace)</option>
                </select>
                <div class="field-hint">Supportivo per PV se aumentata ‚Äî non criterio WHO</div>
            </div>

            <!-- 8. LINEA LINFOIDE -->
            <div class="grid2">
                <div class="field">
                    <label>Linfoide (%)</label>
                    <input type="number" id="lymphoid-percent" min="0" max="100" placeholder="0-100">
                </div>
                <div class="field">
                    <label>Distribuzione</label>
                    <select id="lymphoid-distribution">
                        <option value="">--</option>
                        <option value="normal">Sparsa</option>
                        <option value="paratrabecular">Paratrab.</option>
                        <option value="interstitial">Interstiziale</option>
                        <option value="nodular">Noduli</option>
                        <option value="sheets">A tappeto ‚ö†Ô∏è</option>
                    </select>
                </div>
            </div>

            <!-- 9. STRISCIO ‚Äî lo vede l'ematologo -->
            <div class="field">
                <div class="check-field">
                    <input type="checkbox" id="leukoerythroblastosis">
                    <label for="leukoerythroblastosis">Leucoeritroblastosi (striscio periferico)</label>
                </div>
                <div class="field-hint">Eritroblasti + precursori immaturi in circolo + dacriociti ‚Äî criterio minore PMF WHO 2022<br>‚ö† Dato dello striscio periferico: richiedere referto ematologo se non disponibile</div>
            </div>

            <!-- 10. NOTE LIBERE -->
            <div class="field">
                <label>Note morfologiche</label>
                <textarea id="morphology-notes" placeholder="dacriociti, displasia, anomalie..."></textarea>
            </div>
            <div class="field">
                <label>Displasia morfologica</label>
                <select id="dysplasia">
                    <option value="">-- N/V --</option>
                    <option value="none">Assente</option>
                    <option value="unilineage">Unilineare (1 linea)</option>
                    <option value="multilineage">Multilineare ‚â•2 linee ‚ö†Ô∏è</option>
                </select>
                <div class="field-hint alert">Displasia multilineare significativa ‚Üí escludere MDS prima di PMF</div>
            </div>

            <!-- 11. FIBROSI ‚Äî criterio maggiore WHO 2022, grading su Gomori/Wilder -->
            <div class="field">
                <label>Fibrosi reticolare (MF-grading) ‚Äî Gomori/Wilder</label>
                <select id="fibrosis">
                    <option value="">-- N/V --</option>
                    <option value="0">MF-0 ‚Äî assente</option>
                    <option value="1">MF-1 ‚Äî minima (fibre loose, no intersect.)</option>
                    <option value="2">MF-2 ‚Äî moderata (rete densa, intersect.)</option>
                    <option value="3">MF-3 ‚Äî marcata + fibrosi collagene</option>
                </select>
                <div class="field-hint alert">‚ö† Criterio maggiore WHO 2022 ‚Äî Pre-PMF: ‚â§MF-1 ¬∑ PMF overt: ‚â•MF-2<br>EE orienta (stroma, dacriociti, sinusoidi), Gomori decide</div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-section-title" style="border-color:#db2777;">IHC</div>
            <div class="grid2">
                <div class="field">
                    <label>MPO</label>
                    <select id="mpo">
                        <option value="">-- N/E --</option>
                        <option value="normal">Normale</option>
                        <option value="shift">Deviazione sinistra</option>
                        <option value="marked">Immaturit√† marcata</option>
                        <option value="decreased">Ridotta</option>
                    </select>
                </div>
                <div class="field">
                    <label>CD15</label>
                    <select id="cd15">
                        <option value="">-- N/E --</option>
                        <option value="normal">Normale</option>
                        <option value="weak">Debole</option>
                        <option value="negative">Negativo ‚ö†Ô∏è</option>
                        <option value="reduced">Ridotto</option>
                    </select>
                </div>
            </div>
            <div class="grid2">
                <div class="field">
                    <label>CD68</label>
                    <select id="cd68">
                        <option value="">-- N/E --</option>
                        <option value="negative">Neg/raro</option>
                        <option value="focal">Focale</option>
                        <option value="moderate">Moderato</option>
                        <option value="strong">Forte/diffuso ‚ö†Ô∏è</option>
                    </select>
                </div>
                <div class="field">
                    <label>CD14</label>
                    <select id="cd14">
                        <option value="">-- N/E --</option>
                        <option value="negative">Negativo</option>
                        <option value="weak">Debole</option>
                        <option value="moderate">Moderato</option>
                        <option value="strong">Forte ‚ö†Ô∏è</option>
                    </select>
                </div>
            </div>
            <div class="grid2">
                <div class="field">
                    <label>CD163</label>
                    <select id="cd163">
                        <option value="">-- N/E --</option>
                        <option value="negative">Negativo</option>
                        <option value="weak">Debole</option>
                        <option value="moderate">Moderato</option>
                        <option value="strong">Forte</option>
                    </select>
                </div>
                <div class="field">
                    <label>CD61</label>
                    <select id="cd61">
                        <option value="">-- N/E --</option>
                        <option value="normal">Normale</option>
                        <option value="increased">Aumentati</option>
                        <option value="clustered">Clustering</option>
                        <option value="atypical">Atipici</option>
                    </select>
                </div>
            </div>
            <div class="grid2">
                <div class="field">
                    <label>CD3</label>
                    <select id="cd3">
                        <option value="">-- N/E --</option>
                        <option value="normal">Normale</option>
                        <option value="increased">Aumentati</option>
                        <option value="aggregates">Aggregati</option>
                    </select>
                </div>
                <div class="field">
                    <label>CD20</label>
                    <select id="cd20">
                        <option value="">-- N/E --</option>
                        <option value="normal">Normale</option>
                        <option value="increased">Aumentati</option>
                        <option value="aggregates">Aggregati/follicoli</option>
                    </select>
                </div>
            </div>
            <div class="grid2">
                <div class="field">
                    <label>CD138</label>
                    <select id="cd138">
                        <option value="">-- N/E --</option>
                        <option value="normal">Normale (<5%)</option>
                        <option value="increased">5-10%</option>
                        <option value="high">>10% ‚ö†Ô∏è</option>
                        <option value="clusters">Aggregati</option>
                    </select>
                </div>
                <div class="field">
                    <label>K/Lambda</label>
                    <select id="kappa_lambda">
                        <option value="">-- N/E --</option>
                        <option value="normal">Normale</option>
                        <option value="kappa">Eccesso Œ∫</option>
                        <option value="lambda">Eccesso Œª</option>
                        <option value="severe">Fortemente alterato</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-section-title" style="border-color:#d97706; cursor:pointer; user-select:none;" onclick="toggleLab()">
                Lab &amp; Clinica
                <span id="lab-toggle-icon" style="margin-left:auto; font-size:1.1em; color:#d97706;">‚ñæ</span>
            </div>
            <div id="lab-body">
            <div class="grid2">
                <div class="field">
                    <label>Hb (g/dL)</label>
                    <input type="number" id="hb" step="0.1" min="0" max="25" placeholder="es. 14.5">
                </div>
                <div class="field">
                    <label>Hct (%)</label>
                    <input type="number" id="hct" step="0.1" min="0" max="100" placeholder="es. 42">
                </div>
                <div class="field">
                    <label>PLT (√ó10‚Åπ/L)</label>
                    <input type="number" id="plt" min="0" max="5000" placeholder="es. 650">
                </div>
                <div class="field">
                    <label>WBC (√ó10‚Åπ/L)</label>
                    <input type="number" id="wbc" step="0.1" min="0" max="500" placeholder="es. 12.5">
                </div>
            </div>
            <div class="grid2">
                <div class="field">
                    <label>Blasti (%)</label>
                    <input type="number" id="blasts-percent" min="0" max="100" step="0.5" placeholder="es. 2">
                </div>
                <div class="field">
                    <label>Monociti ass. (√ó10‚Åπ/L)</label>
                    <input type="number" id="monocytes-absolute" step="0.1" min="0" placeholder="es. 1.2">
                </div>
            </div>
            <div class="field">
                <label>EPO sierica</label>
                <select id="epo_result">
                    <option value="">-- N/E --</option>
                    <option value="subnormal">Subnormale (&lt;5.0 mU/mL) ‚Üê criterio minore PV</option>
                    <option value="low_normal">Bassa-normale (5-10)</option>
                    <option value="normal">Normale (10-29)</option>
                    <option value="elevated">Elevata (&gt;29)</option>
                </select>
            </div>
            <div class="field">
                <label>LDH</label>
                <select id="ldh">
                    <option value="">-- N/V --</option>
                    <option value="normal">Normale</option>
                    <option value="elevated">Elevato</option>
                </select>
            </div>
            <div class="field">
                <div class="check-field"><input type="checkbox" id="splenomegaly"><label for="splenomegaly">Splenomegalia</label></div>
                <div class="check-field"><input type="checkbox" id="symptoms"><label for="symptoms">Sintomi costituzionali</label></div>
                <div class="check-field"><input type="checkbox" id="anemia"><label for="anemia">Anemia (clinica)</label></div>
            </div>
            </div><!-- /lab-body -->
        </div>

        <div class="input-section">
            <div class="input-section-title" style="border-color:#7c3aed;">Molecolare &amp; Citogenetica</div>
            <div class="hint-box">JAK2 ‚Üí orientamento PV ¬∑ CALR ‚Üí orientamento Pre-PMF/ET ¬∑ MPL ‚Üí orientamento PMF</div>
            <div class="mut-grid">
                <div class="field">
                    <label>JAK2 V617F</label>
                    <select id="jak2" onchange="updateTripleNeg()">
                        <option value="not_done">Non eseguito</option>
                        <option value="pos">+ Positivo</option>
                        <option value="neg">‚àí Negativo</option>
                    </select>
                </div>
                <div class="field">
                    <label>CALR</label>
                    <select id="calr" onchange="updateTripleNeg()">
                        <option value="not_done">Non eseguito</option>
                        <option value="pos">+ Positivo</option>
                        <option value="neg">‚àí Negativo</option>
                    </select>
                </div>
                <div class="field">
                    <label>MPL</label>
                    <select id="mpl" onchange="updateTripleNeg()">
                        <option value="not_done">Non eseguito</option>
                        <option value="pos">+ Positivo</option>
                        <option value="neg">‚àí Negativo</option>
                    </select>
                </div>
                <div id="triple-neg-banner" style="display:none; grid-column:1/-1; background:#fef9c3; border:1px solid #fcd34d; border-radius:4px; padding:6px 10px; font-size:0.78em; color:#92400e; font-family:'IBM Plex Mono',monospace;">
                    ‚ö† Triplo negativo ‚Äî richiede clonalit√† alternativa (ASXL1, EZH2, TET2, IDH1/2, SRSF2, SF3B1)
                </div>
            </div>
            <div class="field" style="margin-top:10px;">
                <label>Citogenetica</label>
                <select id="cytogenetics">
                    <option value="">-- N/E --</option>
                    <option value="normal">46,XX/XY normale</option>
                    <option value="del5q">del(5q)</option>
                    <option value="trisomy8">Trisomia 8</option>
                    <option value="del20q">del(20q)</option>
                    <option value="t9_22">t(9;22) BCR/ABL ‚ö†Ô∏è</option>
                    <option value="complex">Complesso (>3 anomalie)</option>
                    <option value="other">Altra</option>
                </select>
            </div>
            <div class="field">
                <label>Note citogenetica</label>
                <input type="text" id="cytogenetics-notes" placeholder="es. monosomia 7">
            </div>
        </div>

        <div class="input-section">
            <button class="analyze-btn" onclick="analyzeCase()">‚ñ∂ ANALIZZA CASO</button>
            <button class="reset-btn" onclick="resetForm()">‚äï SBLOCCA NUOVO CASO</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RIGHT: RESULTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="results-panel" id="results-panel">
        <div class="empty-state" id="empty-state">
            <div class="icon">‚¨°</div>
            <p>Inserisci i dati e avvia l'analisi</p>
        </div>
        <div id="result-area" style="display:none;"></div>
    </div>
</div>

<script>
// ============================================================================
// UTILITY
// ============================================================================
function getCellularityRange(age) {
    if (age < 2)   return { min:45, max:85, mean:79.8 };
    if (age < 5)   return { min:50, max:70, mean:59.1 };
    if (age < 20)  return { min:45, max:85, mean:65 };
    if (age <= 40) return { min:40, max:70, mean:55 };
    if (age <= 60) return { min:35, max:65, mean:50 };
    if (age <= 70) return { min:30, max:60, mean:45 };
    return { min:30, max:60, mean:45 };
}

function getAnemiaThreshold(sex, age) {
    if (!sex) return 12.0;
    if (sex === 'M') return (age && age > 65) ? 12.5 : 13.0;
    return (age && age > 65) ? 11.5 : 12.0;
}

function updateCellularityHint() {
    const age = parseInt(document.getElementById('age').value);
    const pct = parseFloat(document.getElementById('cellularity-percent').value);
    const hint = document.getElementById('cellularity-hint');
    const sel = document.getElementById('cellularity');
    if (!age || age <= 0) { hint.textContent = ''; return; }
    const r = getCellularityRange(age);
    if (pct > 0) {
        let label, color, val;
        if (pct >= r.min && pct <= r.max)   { label='NORMALE'; color='var(--success)'; val='normal'; }
        else if (pct > r.max)               { label='‚¨Ü AUMENTATA'; color='var(--danger)'; val='increased'; }
        else                                { label='‚¨á DIMINUITA'; color='var(--warning)'; val='decreased'; }
        hint.innerHTML = `<span style="color:${color};font-weight:600;">${label}</span> (atteso ${r.min}-${r.max}%)`;
        sel.value = val;
    } else {
        hint.innerHTML = `atteso ${r.min}-${r.max}% (media ${r.mean}%)`;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('age').addEventListener('input', updateCellularityHint);
    document.getElementById('cellularity-percent').addEventListener('input', updateCellularityHint);
});

// ============================================================================
// DATA COLLECTION
// ============================================================================
function collectData() {
    const fibVal   = document.getElementById('fibrosis').value;
    const blastVal = document.getElementById('blasts-percent').value;
    return {
        biopsy_date:          document.getElementById('biopsy-date').value,
        biopsy_quality:       document.getElementById('biopsy-quality').value,
        biopsy_length:        parseFloat(document.getElementById('biopsy-length').value) || null,
        biopsy_spaces:        parseFloat(document.getElementById('biopsy-spaces').value) || null,
        age:                  parseInt(document.getElementById('age').value) || null,
        sex:                  document.getElementById('sex').value,
        cellularity_percent:  parseFloat(document.getElementById('cellularity-percent').value) || null,
        cellularity:          document.getElementById('cellularity').value,
        megakaryocyte:        document.getElementById('megakaryocyte').value,
        proliferation:        document.getElementById('proliferation').value,
        fibrosis:             fibVal !== '' ? parseInt(fibVal) : null,
        me_ratio:             document.getElementById('me_ratio').value,
        lymphoid_percent:     parseFloat(document.getElementById('lymphoid-percent').value) || 0,
        lymphoid_distribution:document.getElementById('lymphoid-distribution').value,
        blasts_percent:       blastVal !== '' ? parseFloat(blastVal) : null,
        monocytes_absolute:   parseFloat(document.getElementById('monocytes-absolute').value) || null,
        morphology_notes:     document.getElementById('morphology-notes').value,
        dysplasia:            document.getElementById('dysplasia').value,
        leukoerythroblastosis:document.getElementById('leukoerythroblastosis').checked,
        ecadherin:            document.getElementById('ecadherin').value,
        mpo:                  document.getElementById('mpo').value,
        cd15:                 document.getElementById('cd15').value,
        cd68:                 document.getElementById('cd68').value,
        cd14:                 document.getElementById('cd14').value,
        cd163:                document.getElementById('cd163').value,
        cd61:                 document.getElementById('cd61').value,
        cd3:                  document.getElementById('cd3').value,
        cd20:                 document.getElementById('cd20').value,
        cd138:                document.getElementById('cd138').value,
        kappa_lambda:         document.getElementById('kappa_lambda').value,
        hb:                   parseFloat(document.getElementById('hb').value) || null,
        hct:                  parseFloat(document.getElementById('hct').value) || null,
        plt:                  parseFloat(document.getElementById('plt').value) || null,
        wbc:                  parseFloat(document.getElementById('wbc').value) || null,
        jak2:                 document.getElementById('jak2').value === 'pos',
        calr:                 document.getElementById('calr').value === 'pos',
        mpl:                  document.getElementById('mpl').value === 'pos',
        triple_neg:           ['jak2','calr','mpl'].every(id => document.getElementById(id).value === 'neg'),
        mol_not_done:         ['jak2','calr','mpl'].every(id => document.getElementById(id).value === 'not_done'),
        cytogenetics:         document.getElementById('cytogenetics').value,
        cytogenetics_notes:   document.getElementById('cytogenetics-notes').value,
        splenomegaly:         document.getElementById('splenomegaly').checked,
        symptoms:             document.getElementById('symptoms').checked,
        anemia:               document.getElementById('anemia').checked,
        ldh_elevated:         document.getElementById('ldh').value === 'elevated',
        epo_result:           document.getElementById('epo_result').value,
        clinical_question:    document.getElementById('clinical-question').value
    };
}

// ============================================================================
// MODALIT√Ä 1: WHO 2022 FORMALE
// ============================================================================
function runWHOFormal(data) {
    const hbT  = data.sex === 'M' ? 16.5 : 16.0;
    const hctT = data.sex === 'M' ? 49   : 48;

    // PV
    let pvMaj = 0, pvMin = 0, pvDetails = [];
    const pvHb = (data.hb && data.hb > hbT) || (data.hct && data.hct > hctT);
    pvDetails.push({ met: pvHb, label: `Hb/Hct >soglia (${hbT}/${hctT})` });
    if (pvHb) pvMaj++;
    const pvBx = data.proliferation === 'panmyelosis' && data.megakaryocyte === 'pleomorphic';
    pvDetails.push({ met: pvBx, label: 'Panmielosi + megacariociti pleomorfi' });
    if (pvBx) pvMaj++;
    pvDetails.push({ met: data.jak2, label: 'JAK2 V617F' });
    if (data.jak2) pvMaj++;
    const epoMin = data.epo_result === 'subnormal';
    pvDetails.push({ met: epoMin ? true : null, label: `EPO${data.epo_result ? ': '+data.epo_result : ': N/E'}` });
    if (epoMin) pvMin++;
    const pvDx = (pvMaj >= 3) || (pvMaj >= 2 && pvMin >= 1);

    // ET
    let etMet = 0, etPartial = 0, etDetails = [];
    const etPlt = data.plt !== null && data.plt >= 450;
    etDetails.push({ met: data.plt === null ? null : etPlt, label: `PLT ${data.plt !== null ? data.plt+'√ó10‚Åπ/L' : 'N/V'} (‚â•450)` });
    if (etPlt) etMet++;
    const etMeg = data.megakaryocyte === 'hyperlobulated';
    etDetails.push({ met: etMeg, label: 'Megacariociti iperlobulati maturi' });
    if (etMeg) etMet++;
    const pvF  = pvHb;
    const pmfF = data.fibrosis !== null && data.fibrosis >= 2;
    const cmlF = data.cytogenetics === 't9_22';
    const mdsF = data.blasts_percent !== null && data.blasts_percent >= 5;
    const etExcl = !pvF && !pmfF && !cmlF && !mdsF;
    etDetails.push({ met: etExcl, label: `Esclusione PV/PMF/CML/MDS${!etExcl ? ' ‚úó' : ''}` });
    if (etExcl) etMet++;
    const hasMut = data.jak2 || data.calr || data.mpl;
    if (hasMut) {
        etDetails.push({ met: true, label: `Driver: ${[data.jak2&&'JAK2',data.calr&&'CALR',data.mpl&&'MPL'].filter(Boolean).join('+')}` });
        etMet++;
    } else if (data.triple_neg) {
        etDetails.push({ met: 'partial', label: 'Triple-neg: clonalit√† alternativa richiesta' });
        etPartial++;
    } else {
        etDetails.push({ met: false, label: 'Nessuna mutazione guida' });
    }
    let etDx;
    if (etMet === 4)                          etDx = 'CONFERMATO';
    else if (etMet === 3 && etPartial === 1)  etDx = 'PROBABILE';
    else                                       etDx = 'ESCLUSO';

    // PRE-PMF
    let preMaj = 0, preMin = 0, preMajDetails = [], preMinDetails = [];
    const preMeg = data.megakaryocyte === 'clustered';
    let pre1;
    if (data.fibrosis === null)              pre1 = preMeg ? 'partial' : false;
    else if (preMeg && data.fibrosis <= 1)  { pre1 = true; preMaj++; }
    else if (preMeg && data.fibrosis >= 2)   pre1 = false;
    else                                     pre1 = false;
    preMajDetails.push({ met: pre1, label: `Atipia megacariocitaria + fibrosi ‚â§MF-1${data.fibrosis!==null?' (MF-'+data.fibrosis+')':' (N/V)'}` });
    const etF2 = data.megakaryocyte === 'hyperlobulated' && data.plt !== null && data.plt >= 450;
    const preExcl = !pvHb && !etF2 && !cmlF && !mdsF;
    if (preExcl) preMaj++;
    preMajDetails.push({ met: preExcl, label: 'Esclusione PV/ET/CML/MDS' });
    let pre3;
    if (hasMut) { pre3 = true; preMaj++; }
    else if (data.triple_neg) pre3 = 'partial';
    else pre3 = false;
    preMajDetails.push({ met: pre3, label: `Mutazione clonale${hasMut?' ('+[data.jak2&&'JAK2',data.calr&&'CALR',data.mpl&&'MPL'].filter(Boolean).join('+')+')':data.triple_neg?' triple-neg':' assente'}` });
    const anemiaT = getAnemiaThreshold(data.sex, data.age);
    const anemiaOk = data.anemia || (data.hb !== null && data.hb < anemiaT);
    if (anemiaOk) preMin++;
    const anemiaLabel = data.hb ? `Anemia (Hb ${data.hb} vs soglia ${anemiaT})` : 'Anemia';
    preMinDetails.push({ met: anemiaOk, label: anemiaLabel });
    const wcbHigh = data.wbc !== null && data.wbc >= 11;
    if (wcbHigh) preMin++;
    preMinDetails.push({ met: wcbHigh, label: `Leucocitosi${data.wbc?' '+data.wbc+'√ó10‚Åπ/L':''}` });
    if (data.splenomegaly) preMin++;
    preMinDetails.push({ met: data.splenomegaly, label: 'Splenomegalia' });
    if (data.ldh_elevated) preMin++;
    preMinDetails.push({ met: data.ldh_elevated, label: 'LDH elevato' });
    const pre1Met = preMajDetails[0].met === true;
    let preDx;
    if (preMaj >= 3 && preMin >= 1)                preDx = 'CONFERMATO';
    else if (preMaj >= 2 && preMin >= 1 && pre1Met) preDx = 'PROBABILE';
    else                                            preDx = 'ESCLUSO';

    // PMF
    let pmfMaj = 0, pmfMin = 0, pmfMajD = [], pmfMinD = [];
    let pmf1Met = false;
    if (data.fibrosis === null) {
        pmfMajD.push({ met: data.megakaryocyte==='clustered'?'partial':false, label: `Clustering + fibrosi MF-2/3 (fibrosi N/V)` });
    } else if (data.megakaryocyte === 'clustered' && data.fibrosis >= 2) {
        pmf1Met = true; pmfMaj++;
        pmfMajD.push({ met: true, label: `Clustering + fibrosi MF-${data.fibrosis}` });
    } else {
        pmfMajD.push({ met: false, label: `Clustering/fibrosi insufficienti (MF-${data.fibrosis!==null?data.fibrosis:'N/V'})` });
    }
    // Esclusione MDS per PMF: blast-based + displasia multilineare + citogenetica MDS-type
    const mdsCyto = ['del5q','trisomy8','del20q','complex'].includes(data.cytogenetics) ||
                    /monosomia\s*7|del.*7q|-7|del.*5q|-5|complex/i.test(data.cytogenetics_notes||'');
    const mdsMultiDisp = data.dysplasia === 'multilineage';
    const mdsBlasts = data.blasts_percent !== null && data.blasts_percent >= 5 && data.blasts_percent < 20;
    const mdsF_pmf = mdsBlasts || mdsMultiDisp || mdsCyto;
    const pmfExcl = !pvHb && !cmlF && !mdsF_pmf;
    if (pmfExcl) pmfMaj++;
    let pmfExclDetail;
    if (pmfExcl) {
        pmfExclDetail = 'Esclusione PV/CML/MDS';
    } else {
        const why = [];
        if (pvHb)          why.push('PV: Hb/Hct');
        if (cmlF)          why.push('CML: t(9;22)');
        if (mdsBlasts)     why.push(`MDS: blasti ${data.blasts_percent}%`);
        if (mdsMultiDisp)  why.push('MDS: displasia multilineare');
        if (mdsCyto)       why.push(`MDS: citogenetica ${data.cytogenetics}`);
        pmfExclDetail = `Esclusione PV/CML/MDS ‚úó (${why.join(', ')})`;
    }
    pmfMajD.push({ met: pmfExcl, label: pmfExclDetail });
    let pmf3;
    if (hasMut) { pmf3 = true; pmfMaj++; }
    else if (data.triple_neg) pmf3 = 'partial';
    else pmf3 = false;
    pmfMajD.push({ met: pmf3, label: `Mutazione clonale` });
    if (anemiaOk) pmfMin++;
    pmfMinD.push({ met: anemiaOk, label: `Anemia` });
    if (wcbHigh) pmfMin++;
    pmfMinD.push({ met: wcbHigh, label: `Leucocitosi` });
    if (data.splenomegaly) pmfMin++;
    pmfMinD.push({ met: data.splenomegaly, label: 'Splenomegalia' });
    if (data.ldh_elevated) pmfMin++;
    pmfMinD.push({ met: data.ldh_elevated, label: 'LDH elevato' });
    if (data.leukoerythroblastosis) pmfMin++;
    pmfMinD.push({ met: data.leukoerythroblastosis, label: 'Leucoeritroblastosi' });
    let pmfDx;
    if (pmfMaj >= 3 && pmfMin >= 1)                 pmfDx = 'CONFERMATO';
    else if (pmfMaj >= 2 && pmf1Met && pmfMin >= 1) pmfDx = 'PROBABILE';
    else                                             pmfDx = 'ESCLUSO';

    return {
        pv:  { dx: pvDx  ? 'CONFERMATO':'ESCLUSO', details: pvDetails, summary: `Maggiori ${pvMaj}/3, Minori ${pvMin}/1` },
        et:  { dx: etDx,  details: etDetails, summary: `Criteri ${etMet}/4${etPartial?' +'+etPartial+' parziale':''}` },
        pre: { dx: preDx, majDetails: preMajDetails, minDetails: preMinDetails, summary: `Maggiori ${preMaj}/3, Minori ${preMin}/4`, tripleNeg: data.triple_neg && !hasMut },
        pmf: { dx: pmfDx, majDetails: pmfMajD, minDetails: pmfMinD, summary: `Maggiori ${pmfMaj}/3, Minori ${pmfMin}/5` }
    };
}

// ============================================================================
// MODALIT√Ä 2: PATTERN MORFOLOGICO
// ============================================================================
function runPatternMorfo(data) {
    let scores = { ET:0, PV:0, PrePMF:0, PMF:0 };
    let reasoning = { ET:[], PV:[], PrePMF:[], PMF:[] };

    // ET
    if (data.megakaryocyte === 'hyperlobulated') { scores.ET+=35; reasoning.ET.push({t:'Iperlobulati maturi',p:+35}); }
    if (data.proliferation === 'megakaryocytic') { scores.ET+=30; reasoning.ET.push({t:'Proliferazione megacariocitica',p:+30}); }
    if (data.fibrosis !== null && data.fibrosis <= 1) { scores.ET+=25; reasoning.ET.push({t:`Fibrosi MF-${data.fibrosis}`,p:+25}); }
    if (data.cd61 === 'increased') { scores.ET+=10; reasoning.ET.push({t:'CD61 aumentati',p:+10}); }
    if (data.me_ratio === 'normal') { scores.ET+=10; reasoning.ET.push({t:'M/E normale',p:+10}); }
    const hbT = data.sex==='M'?16.5:16.0;
    if (data.hb !== null && data.hb > hbT) { scores.ET-=40; reasoning.ET.push({t:`Hb ${data.hb} ‚Üí PV`,p:-40}); }
    if (data.plt !== null && data.plt >= 800 && data.megakaryocyte === 'hyperlobulated') {
        scores.ET+=15; reasoning.ET.push({t:'PLT ‚â•800 + iperlobulati (ET alta)',p:+15}); }

    // PV
    if (data.proliferation === 'panmyelosis') { scores.PV+=35; reasoning.PV.push({t:'Panmielosi trilineare',p:+35}); }
    if (data.cellularity === 'increased') { scores.PV+=25; reasoning.PV.push({t:'Cellularit√† aumentata',p:+25}); }
    if (data.me_ratio === 'decreased'||data.me_ratio === 'inverted') { scores.PV+=30; reasoning.PV.push({t:'M/E ridotto (eritropoiesi accelerata)',p:+30}); }
    if (data.megakaryocyte === 'pleomorphic') { scores.PV+=20; reasoning.PV.push({t:'Megacariociti pleomorfi',p:+20}); }
    if (data.ecadherin === 'increased') { scores.PV+=15; reasoning.PV.push({t:'E-caderina aumentata (supportivo)',p:+15}); }
    else if (data.ecadherin === 'absent') { scores.PV-=20; reasoning.PV.push({t:'E-caderina assente',p:-20}); }
    if ((data.hb !== null && data.hb > hbT)||(data.hct !== null && data.hct > (data.sex==='M'?49:48))) {
        scores.PV+=15; reasoning.PV.push({t:'Hb/Hct >soglia PV',p:+15}); }
    if (data.fibrosis !== null && data.fibrosis >= 2) {
        const p = data.fibrosis===3?-50:-40; scores.PV+=p; reasoning.PV.push({t:`Fibrosi MF-${data.fibrosis} ‚Üí PMF`,p}); }

    // PMF
    if (data.megakaryocyte === 'clustered') { scores.PMF+=35; reasoning.PMF.push({t:'Aggregazione + atipia',p:+35}); }
    if (data.fibrosis !== null && data.fibrosis >= 2) {
        const b = data.fibrosis===3?45:40; scores.PMF+=b; reasoning.PMF.push({t:`Fibrosi MF-${data.fibrosis}`,p:+b}); }
    if (data.cd61 === 'clustered'||data.cd61 === 'atypical') { scores.PMF+=15; reasoning.PMF.push({t:'CD61 aggregazione/atipie',p:+15}); }
    if (data.me_ratio === 'increased') { scores.PMF+=15; reasoning.PMF.push({t:'M/E aumentato',p:+15}); }
    if (data.ecadherin === 'absent') { scores.PMF+=20; reasoning.PMF.push({t:'E-caderina ridotta',p:+20}); }
    if (data.leukoerythroblastosis) { scores.PMF+=15; reasoning.PMF.push({t:'Leucoeritroblastosi',p:+15}); }
    if (data.fibrosis !== null && data.fibrosis <= 1 && data.cd61 !== 'clustered') {
        scores.PMF-=40; reasoning.PMF.push({t:'Fibrosi minima senza atipia',p:-40}); }

    // Pre-PMF
    if (data.megakaryocyte === 'clustered') { scores.PrePMF+=30; reasoning.PrePMF.push({t:'Aggregazione megacariociti',p:+30}); }
    if (data.fibrosis === 1) { scores.PrePMF+=40; reasoning.PrePMF.push({t:'Fibrosi MF-1 (chiave)',p:+40}); }
    else if (data.fibrosis === 0) { scores.PrePMF+=8; reasoning.PrePMF.push({t:'MF-0 con aggregazione (sovrapposizione ET)',p:+8}); }
    else if (data.fibrosis === null) { reasoning.PrePMF.push({t:'Fibrosi N/V ‚Äî dato critico mancante',p:0}); }
    else if (data.fibrosis >= 2) { scores.PrePMF-=50; reasoning.PrePMF.push({t:'Fibrosi marcata ‚Üí PMF overt',p:-50}); }
    if (data.plt !== null && data.plt >= 800 && data.megakaryocyte === 'hyperlobulated') {
        scores.PrePMF-=25; reasoning.PrePMF.push({t:'PLT ‚â•800 + iperlobulati ‚Üí ET vera',p:-25}); }

    Object.keys(scores).forEach(k => scores[k] = Math.min(100, Math.max(0, scores[k])));
    const sorted = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
    return { scores, reasoning, ranked: sorted };
}

// ============================================================================
// MODALIT√Ä 3: CLINICO-MOLECOLARE
// ============================================================================
function runClinMol(data) {
    const hbT  = data.sex==='M'?16.5:16.0;
    const hctT = data.sex==='M'?49:48;
    let items = [];

    // Mutazioni con bias differenziale
    if (data.jak2) {
        items.push({ label:'JAK2 V617F', value:'POSITIVO', type:'pos', bias:'PV ‚â´ ET > Pre-PMF',
            note:'JAK2 presente in ~95% PV, ~55% ET, ~50% PMF' });
    }
    if (data.calr) {
        items.push({ label:'CALR', value:'MUTATO', type:'pos', bias:'ET / Pre-PMF',
            note:'CALR tipo 1 ‚Üí orientamento PMF; tipo 2 ‚Üí orientamento ET (sottotipo non discriminabile senza sequenziamento)' });
    }
    if (data.mpl) {
        items.push({ label:'MPL', value:'MUTATO', type:'pos', bias:'PMF > ET',
            note:'MPL W515L/K: associazione preferenziale PMF e fibrosi progressiva' });
    }
    if (data.triple_neg) {
        items.push({ label:'Triple-negativo', value:'CONFERMATO', type:'partial', bias:'Incerto',
            note:'JAK2/CALR/MPL tutti negativi. Richiede esclusione reattiva + mutazione clonale alternativa (ASXL1, EZH2, TET2, IDH1/2, SRSF2, SF3B1)' });
    }
    if (!data.jak2 && !data.calr && !data.mpl && !data.triple_neg) {
        items.push({ label:'Pannello mutazioni driver', value:'NON ESEGUITO', type:'neg', bias:'‚Äî',
            note: data.mol_not_done
                ? 'Eseguire JAK2 V617F come minimo. Senza dato molecolare la classificazione WHO 2022 √® incompleta.'
                : 'Dati insufficienti per classificazione' });
    }

    // Emocromo interpretato
    if (data.hb && data.hb > hbT) items.push({ label:`Hb ${data.hb} g/dL`, value:'ALTA', type:'pos', bias:'PV', note:`Soglia PV: >${hbT}` });
    if (data.hct && data.hct > hctT) items.push({ label:`Hct ${data.hct}%`, value:'ALTO', type:'pos', bias:'PV', note:`Soglia PV: >${hctT}%` });
    if (data.plt && data.plt >= 450) items.push({ label:`PLT ${data.plt}√ó10‚Åπ/L`, value: data.plt>=1000?'MOLTO ALTA':'ALTA', type:'pos', bias: data.plt>=800?'ET (trombocitosi estrema)':'ET/Pre-PMF', note:'PLT ‚â•800: forte orientamento ET' });
    if (data.wbc && data.wbc >= 11) items.push({ label:`WBC ${data.wbc}√ó10‚Åπ/L`, value:'LEUCOCITOSI', type:'partial', bias:'PMF/Pre-PMF minore', note:'Criterio minore PMF e Pre-PMF' });
    if (data.epo_result === 'subnormal') items.push({ label:'EPO sierica', value:'SUBNORMALE', type:'pos', bias:'PV (criterio minore)', note:'<5.0 mU/mL: criterio minore WHO PV' });
    if (data.splenomegaly) items.push({ label:'Splenomegalia', value:'PRESENTE', type:'partial', bias:'PMF/Pre-PMF', note:'Criterio minore per PMF e Pre-PMF' });
    if (data.ldh_elevated) items.push({ label:'LDH', value:'ELEVATO', type:'partial', bias:'PMF/Pre-PMF', note:'Indicatore di turnover midollare aumentato' });
    if (data.leukoerythroblastosis) items.push({ label:'Leucoeritroblastosi', value:'PRESENTE', type:'pos', bias:'PMF overt', note:'Criterio minore specifico PMF overt' });
    if (data.monocytes_absolute && data.monocytes_absolute > 1) items.push({ label:`Monociti ${data.monocytes_absolute}√ó10‚Åπ/L`, value:'ELEVATI', type:'neg', bias:'LMMC (attenzione)', note:'>1√ó10‚Åπ/L persistenti: escludere LMMC prima di NMC' });
    if (data.cytogenetics === 't9_22') items.push({ label:'t(9;22)', value:'POSITIVO', type:'neg', bias:'CML ‚Äî ESCLUDE NMC', note:'BCR/ABL esclude classificazione come NMC classica' });

    // Sintesi bias molecolare
    let molBias = null;
    if (data.jak2 && !data.calr && !data.mpl) molBias = { label:'JAK2 solo', dx:'PV/ET preferenziale', color:'var(--who-color)' };
    else if (data.calr && !data.jak2) molBias = { label:'CALR solo', dx:'ET / Pre-PMF preferenziale', color:'var(--morfo-color)' };
    else if (data.mpl && !data.jak2) molBias = { label:'MPL solo', dx:'PMF preferenziale', color:'var(--mol-color)' };
    else if (data.jak2 && (data.calr || data.mpl)) molBias = { label:'Doppia mutazione', dx:'Rivalutare ‚Äî raro', color:'var(--danger)' };

    return { items, molBias };
}

// ============================================================================
// RED FLAGS
// ============================================================================
function detectRedFlags(data) {
    let flags = [];
    if (data.blasts_percent !== null && data.blasts_percent > 20)
        flags.push({ title:'BLASTI >20% ‚Äî AML', msg:`Blasti ${data.blasts_percent}%`, action:'Citogenetica STAT, NGS: FLT3, NPM1, CEBPA, TP53', severity:1 });
    else if (data.blasts_percent !== null && data.blasts_percent >= 10)
        flags.push({ title:'Blasti 10-20% ‚Äî trasformazione blastica', msg:`Blasti ${data.blasts_percent}%`, action:'Citogenetica urgente. Escludere progressione NMC ‚Üí AML.', severity:1 });
    else if (data.blasts_percent !== null && data.blasts_percent >= 5) {
        const mdsContext = data.dysplasia === 'multilineage' || ['del5q','complex'].includes(data.cytogenetics);
        flags.push({ title:'Blasti 5-9% ‚Äî zona grigia NMC/MDS',
            msg:`Blasti ${data.blasts_percent}%${mdsContext?' + displasia/citogenetica MDS-type':''} ‚Äî compatibile con NMC ma escludere MDS`,
            action: mdsContext
                ? 'Alta probabilit√† MDS: pannello NGS (SF3B1, SRSF2, TET2, ASXL1), citofluorimetria blasti.'
                : 'Correlare con displasia morfologica e citogenetica. Se displasia multilineare presente ‚Üí MDS probabile.',
            severity:2 });
    }
    if (data.cd68==='strong' && data.cd14==='strong' && data.cd163==='strong') {
        const lmmc = data.monocytes_absolute !== null && data.monocytes_absolute > 1;
        flags.push({ title: lmmc ? 'LMMC CONFERMATO' : 'LMMC SOSPETTO',
            msg: `CD68++/CD14++/CD163++${lmmc?' + Monociti '+data.monocytes_absolute+'√ó10‚Åπ/L':''}`,
            action: lmmc ? 'LMMC confermato ‚Äî esclude NMC' : 'Correlare con monociti periferici assoluti', severity:1 });
    }
    // CD15- con MPO alta: displasia granulocitaria se blasti <20%, AML sospetto se blasti ‚â•20%
    if (data.mpo === 'marked' && data.cd15 === 'negative') {
        const blastHigh = data.blasts_percent !== null && data.blasts_percent >= 20;
        flags.push({
            title: blastHigh ? 'AML SOSPETTO' : 'Displasia granulocitaria',
            msg: `MPO aumentata + CD15 negativo${data.blasts_percent !== null ? ' ¬∑ Blasti ' + data.blasts_percent + '%' : ''}`,
            action: blastHigh
                ? 'CD34, CD117, citogenetica urgente. Blastosi ‚â•20%: escludere AML.'
                : 'CD15- con MPO alta in assenza di blastosi franca ‚Üí displasia granulocitaria. Correlare con morfologia e citogenetica MDS.',
            severity: blastHigh ? 1 : 2
        });
    }
    // CD68++/CD14- : pattern monocitario atipico ‚Äî non AML
    if (data.cd68 === 'strong' && data.cd14 === 'negative')
        flags.push({ title:'Macrofagi/istiociti CD68+ CD14-', msg:'Possibile infiltrato istiocitario reattivo o linfoma istiocitico', action:'Correlare con clinica. Se massa o linfoadenopatia: escludere linfoma istiocitico/dendritico.', severity:2 });
    if (data.lymphoid_percent > 20) {
        const sev = data.lymphoid_distribution==='sheets' ? 1 : 2;
        flags.push({ title: sev===1 ? 'LINFOMA AGGRESSIVO' : 'Linfoma midollare',
            msg:`Linfoide ${data.lymphoid_percent}%${data.lymphoid_distribution==='sheets'?' (a tappeto)':''}`,
            action:'Citofluorimetria, BCL2/BCL6, NGS TCR/IGH', severity:sev });
    }
    if (data.cd138==='high')
        flags.push({ title:'MIELOMA SOSPETTO', msg:'CD138 >10%', action:'Immunofissazione, catene leggere libere', severity:1 });
    if (data.cytogenetics==='t9_22')
        flags.push({ title:'t(9;22) CML', msg:'BCR/ABL positivo ‚Äî esclude NMC classiche', action:'Imatinib, valutare fase', severity:1 });

    // MDS: displasia multilineare e/o citogenetica MDS-type senza blastosi franca
    const mdsCytoFlag = ['del5q','complex'].includes(data.cytogenetics) ||
                        /monosomia\s*7|del.*7q|-7/i.test(data.cytogenetics_notes||'');
    const mdsDispFlag = data.dysplasia === 'multilineage';
    if ((mdsDispFlag || mdsCytoFlag) && !(data.blasts_percent !== null && data.blasts_percent >= 20)) {
        flags.push({ title: 'MDS ‚Äî ESCLUSIONE RICHIESTA',
            msg: `${mdsDispFlag?'Displasia multilineare':''}${mdsDispFlag&&mdsCytoFlag?' + ':''}${mdsCytoFlag?'Citogenetica MDS-type ('+data.cytogenetics+(data.cytogenetics_notes?' / '+data.cytogenetics_notes:'')+')':''}`,
            action: 'WHO 2022: PMF richiede esclusione MDS non solo blast-based. Valutare displasia per linea, ferro/sideroblasti ad anello (SF3B1), pannello NGS MDS.',
            severity: 2 });
    }
    const hbT = data.sex === 'M' ? 16.5 : 16.0;
    const hbNormal = data.hb !== null && data.hb <= hbT;
    const pvPostF = data.jak2 && data.fibrosis !== null && data.fibrosis >= 2
                    && (hbNormal || data.me_ratio === 'decreased' || data.me_ratio === 'inverted');
    if (pvPostF)
        flags.push({ title:'PV POST-FIBROTICA (fase esaurita)',
            msg:`JAK2+ ¬∑ Fibrosi MF-${data.fibrosis} ¬∑ Hb${data.hb?' '+data.hb+' g/dL':' N/V'} ‚Äî eritrocitosi non pi√π evidente`,
            action:'Verificare Hb/Hct storici. PV in fase fibrotica: escludere prima di classificare come PMF de novo.',
            severity:2 });

    // PV MASCHERATA: JAK2+ + panmielosi ma Hb nella norma
    const pvMasked = data.jak2 && data.proliferation === 'panmyelosis'
                     && data.hb !== null && data.hb <= hbT;
    if (pvMasked && !pvPostF)
        flags.push({ title:'PV MASCHERATA ‚Äî sospetto',
            msg:`JAK2+ ¬∑ Panmielosi ¬∑ Hb ${data.hb} g/dL (‚â§${hbT}) ‚Äî eritrocitosi relativa?`,
            action:'Controllare: volume plasmatico, ferro sierico, ferritina. Hb pu√≤ essere falsamente normale in caso di espansione plasmatica o carenza marziale.',
            severity:2 });

    return flags;
}

// ============================================================================
// DISCORDANCE DETECTION
// ============================================================================
function detectDiscordance(who, morfo, mol, data) {
    const discordances = [];

    // WHO vs Morfo
    const whoPrimary = ['pv','et','pre','pmf'].find(k => who[k].dx === 'CONFERMATO' || who[k].dx === 'PROBABILE');
    const morphoPrimary = morfo.ranked[0][0]; // es. "ET"
    const morfoMap = { ET:'et', PV:'pv', PrePMF:'pre', PMF:'pmf' };
    const morphoKey = morfoMap[morphoPrimary];

    if (whoPrimary && morphoKey && whoPrimary !== morphoKey && morfo.ranked[0][1] > 40) {
        discordances.push({
            title: 'WHO vs Quadro Morfologico',
            detail: `WHO formale ‚Üí ${whoPrimary.toUpperCase()} ${who[whoPrimary].dx} ¬∑ Morfologia ‚Üí ${morphoPrimary} (punteggio ${morfo.ranked[0][1]})`,
            action: getDiscordanceAction(whoPrimary, morphoKey, data)
        });
    }

    // WHO vs Molecolare
    if (data.calr && !data.jak2 && whoPrimary === 'pv') {
        discordances.push({
            title: 'Molecolare vs WHO',
            detail: 'CALR+ senza JAK2 ‚Äî incongruente con PV (JAK2 √® la mutazione guida della PV nel 95% dei casi)',
            action: 'Rivalutare criteri morfologici PV. Considerare ET o Pre-PMF CALR-correlata.'
        });
    }
    if (data.jak2 && morfo.ranked[0][0] === 'PMF' && morfo.scores.PV > 40) {
        discordances.push({
            title: 'JAK2 vs Quadro PMF',
            detail: `JAK2+ con quadro morfologico PMF predominante (punteggio PMF: ${morfo.scores.PMF}) ma punteggio PV anche alto (${morfo.scores.PV})`,
            action: 'Escludere PV in fase fibrotica (post-PV MF). Rivalutare Hb/Hct storici.'
        });
    }

    // Fibrosi critica
    if (data.fibrosis === null && (whoPrimary === 'pre' || whoPrimary === 'pmf' || morphoPrimary === 'PrePMF' || morphoPrimary === 'PMF')) {
        discordances.push({
            title: 'Fibrosi non valutata',
            detail: 'La diagnosi suggerita richiede grading MF per la classificazione definitiva',
            action: 'Rivalutare sezione con colorazione reticolare (Gomori). Dato discriminante Pre-PMF vs PMF overt.'
        });
    }

    return discordances;
}

function getDiscordanceAction(whoKey, morfoKey, data) {
    const pair = `${whoKey}‚Üí${morfoKey}`;
    const actions = {
        'et‚Üípre':  'Rivalutare fibrosi. Aggregazione lieve con MF-1 pu√≤ anticipare la progressione a Pre-PMF pur soddisfacendo criteri ET. Controllo a 12 mesi.',
        'et‚Üípmf':  'Fibrosi MF-2/3 in caso WHO-ET: possibile progressione post-ET. Rivalutare storia clinica.',
        'pre‚Üíet':  'Morfologia iperlobulata pura con alta PLT: considerare ET. Pre-PMF richiede atipia franca.',
        'pre‚Üípmf': 'Morfologia PMF-like ma fibrosi ‚â§MF-1: classificazione Pre-PMF corretta se criteri WHO soddisfatti.',
        'pv‚Üíet':   'Quadro morfologico ET ma criteri PV soddisfatti: verificare Hb/Hct e EPO.',
        'pv‚Üípre':  'JAK2+ con aggregazione: escludere PV mascherata con eritrocitosi relativa.',
        'pmf‚Üíet':  'Fibrosi MF-2/3 ma quadro ET: valutare post-ET MF.',
        'pmf‚Üípre': 'Criteri PMF soddisfatti ma quadro morfologico Pre-PMF: rivalutare fibrosi.'
    };
    return actions[pair] || 'Correlazione clinico-patologica multidisciplinare raccomandata.';
}

// ============================================================================
// MPN-U
// ============================================================================
function checkMPNU(who, redFlags) {
    if (redFlags.some(f => f.severity === 1)) return null;
    const allOut = ['pv','et','pre','pmf'].every(k => who[k].dx === 'ESCLUSO' || who[k].dx === 'NON_CONFERMATO');
    if (!allOut) return null;
    return {
        recs: [
            'Pannello molecolare esteso: ASXL1, EZH2, TET2, IDH1/2, SRSF2, SF3B1',
            'Escludere cause reattive (infezione, neoplasie solide, farmaci)',
            'Repeat biopsy se morfologia borderline',
            'Correlazione ematologica multidisciplinare',
            'Nota: ICC 2022 pu√≤ classificare diversamente rispetto a WHO 2022'
        ]
    };
}

// ============================================================================
// REPORT GENERATOR
// ============================================================================
function generateReport(data, who, morfo, mol, discordances, redFlags, mpnu) {
    const now = data.biopsy_date || new Date().toISOString().slice(0,10);
    let r = `REFERTO ISTOLOGICO ‚Äî BIOPSIA OSTEOMIDOLLARE\n`;
    r += `${'‚îÄ'.repeat(60)}\n`;
    r += `Data: ${now}`;
    if (data.clinical_question) r += `  |  Quesito: ${data.clinical_question}`;
    r += `\n${'‚îÄ'.repeat(60)}\n\n`;
    r += `CAMPIONE\n`;
    r += `  Qualit√†: ${data.biopsy_quality||'N/V'}`;
    if (data.biopsy_length) r += `  |  Lunghezza: ${data.biopsy_length} mm`;
    if (data.biopsy_spaces) r += `  |  Spazi: ${data.biopsy_spaces}`;
    r += `\n\nMORFOLOGIA\n`;
    r += `  Cellularit√†: ${data.cellularity_percent||'N/V'}% (${data.cellularity||'N/V'})\n`;
    r += `  Megacariociti: ${data.megakaryocyte||'N/V'}\n`;
    r += `  Proliferazione: ${data.proliferation||'N/V'}\n`;
    r += `  Fibrosi: ${data.fibrosis!==null?'MF-'+data.fibrosis:'non valutata'}\n`;
    r += `  M/E: ${data.me_ratio||'N/V'}\n`;
    r += `  Blasti: ${data.blasts_percent!==null?data.blasts_percent+'%':'N/V'}\n`;
    r += `  Leucoeritroblastosi: ${data.leukoerythroblastosis?'presente':'non documentata'}\n`;
    if (data.morphology_notes) r += `  Note: ${data.morphology_notes}\n`;
    r += `\nIMMUNOISTOCHIMICA\n`;
    r += `  E-caderina: ${data.ecadherin||'N/E'}  M/E: ${data.me_ratio||'N/V'}  Leucoeritroblastosi: ${data.leukoerythroblastosis?'presente':'no'}\n`;
    r += `  MPO: ${data.mpo||'N/E'}  CD15: ${data.cd15||'N/E'}\n`;
    r += `  CD68: ${data.cd68||'N/E'}  CD14: ${data.cd14||'N/E'}  CD163: ${data.cd163||'N/E'}\n`;
    r += `  CD61: ${data.cd61||'N/E'}  CD3: ${data.cd3||'N/E'}  CD20: ${data.cd20||'N/E'}  CD138: ${data.cd138||'N/E'}\n`;
    const labFields = [data.hb, data.hct, data.plt, data.wbc, data.epo_result, data.ldh_elevated||null];
    const labPresent = labFields.some(v => v !== null && v !== '' && v !== undefined && v !== false);
    const labCritical = [data.hb, data.plt, data.wbc].some(v => v !== null && v !== undefined && v !== '');

    r += `\nDATI CLINICO-LAB\n`;
    if (!labPresent) {
        r += `  ‚ö† DATI NON DISPONIBILI AL MOMENTO DELLA REFERTAZIONE\n`;
        r += `  La classificazione WHO 2022 richiede correlazione con emocromo, molecolare e clinica.\n`;
        r += `  ‚Üí Indispensabile confronto clinico-ematologico per diagnosi definitiva.\n`;
    } else {
        if (!labCritical) {
            r += `  ‚ö† Dati clinico-lab parziali ‚Äî valutazione nel contesto clinico necessaria.\n`;
        }
        if (data.hb)  r += `  Hb: ${data.hb} g/dL\n`;
        if (data.hct) r += `  Hct: ${data.hct}%\n`;
        if (data.plt) r += `  PLT: ${data.plt}√ó10‚Åπ/L\n`;
        if (data.wbc) r += `  WBC: ${data.wbc}√ó10‚Åπ/L\n`;
        if (data.epo_result) r += `  EPO: ${data.epo_result}\n`;
        if (data.ldh_elevated) r += `  LDH: elevato\n`;
        if (data.splenomegaly) r += `  Splenomegalia: presente\n`;
        if (data.symptoms) r += `  Sintomi costituzionali: presenti\n`;
    }
    const muts = [data.jak2&&'JAK2',data.calr&&'CALR',data.mpl&&'MPL',data.triple_neg&&'Triple-negativo',data.mol_not_done&&'Molecolare N/E'].filter(Boolean);
    if (muts.length) r += `  Molecolare: ${muts.join(', ')}\n`;
    if (data.cytogenetics) r += `  Citogenetica: ${data.cytogenetics}${data.cytogenetics_notes?' ('+data.cytogenetics_notes+')':''}\n`;
    r += `\nCLASSIFICAZIONE WHO 2022 (Collegio Parallelo)\n`;
    r += `${'‚îÄ'.repeat(60)}\n`;
    r += `  [WHO Formale]\n`;
    r += `    PV:      ${who.pv.dx} (${who.pv.summary})\n`;
    r += `    ET:      ${who.et.dx} (${who.et.summary})\n`;
    r += `    Pre-PMF: ${who.pre.dx} (${who.pre.summary})\n`;
    r += `    PMF:     ${who.pmf.dx} (${who.pmf.summary})\n\n`;
    r += `  [Quadro Morfologico]\n`;
    morfo.ranked.forEach(([k,s]) => { r += `    ${k.padEnd(8)}: ${s}/100\n`; });
    r += `\n  [Clinico-Molecolare]\n`;
    if (mol.molBias) r += `    Orientamento molecolare: ${mol.molBias.label} ‚Üí ${mol.molBias.dx}\n`;
    if (discordances.length) {
        r += `\nDISCORDANZE TRA PROSPETTIVE\n`;
        discordances.forEach(d => { r += `  ‚ö† ${d.title}: ${d.detail}\n    ‚Üí ${d.action}\n`; });
    }
    if (mpnu) r += `\nCLASSIFICAZIONE: MPN-U ‚Äî vedi raccomandazioni\n`;
    if (redFlags.length) {
        r += `\nRED FLAGS\n`;
        redFlags.forEach(f => { r += `  üö® ${f.title}: ${f.msg}\n     ‚Üí ${f.action}\n`; });
    }
    return r;
}

// ============================================================================
// RENDER
// ============================================================================
function dxClass(dx) {
    if (!dx) return 'excluded';
    if (dx.includes('CONFERMATO')) return 'confirmed';
    if (dx.includes('PROBABILE'))  return 'probable';
    return 'excluded';
}

function critIcon(met) {
    if (met === true)      return { cls:'met',     sym:'‚úì' };
    if (met === false)     return { cls:'not-met',  sym:'‚úó' };
    if (met === 'partial') return { cls:'partial',  sym:'‚óê' };
    return { cls:'unknown', sym:'¬∑' };
}

function renderWHOPanel(who) {
    let h = '';

    // Summary chips
    const entities = [
        { key:'pv',  label:'PV',      dx:who.pv.dx,  summary:who.pv.summary },
        { key:'et',  label:'ET',      dx:who.et.dx,  summary:who.et.summary },
        { key:'pre', label:'Pre-PMF', dx:who.pre.dx, summary:who.pre.summary },
        { key:'pmf', label:'PMF',     dx:who.pmf.dx, summary:who.pmf.summary }
    ];
    h += '<div class="dx-row">';
    entities.forEach(e => {
        const cls = dxClass(e.dx);
        const statusLabel = e.dx.replace('CONFERMATO','‚úì CONF.').replace('PROBABILE','~ PROB.').replace('ESCLUSO','‚Äî EXC.').replace('NON_CONFERMATO','‚Äî N/C');
        h += `<div class="dx-item ${cls}">
            <span class="dx-label">${e.label}</span>
            <span class="dx-status">${statusLabel}</span>
        </div>`;
    });
    h += '</div>';

    // Detail per entit√† confermata o probabile
    const active = entities.find(e => e.dx.includes('CONFERMATO') || e.dx.includes('PROBABILE'));
    if (active) {
        h += '<div class="criteria-detail">';
        h += `<div class="criteria-label">${active.label} ‚Äî ${active.key === 'et' ? 'Criteri' : 'Criteri'}</div>`;
        const src = who[active.key];
        const allDetails = active.key === 'et' ? src.details :
                           active.key === 'pv' ? src.details :
                           [...(src.majDetails||[]).map(d=>({...d,prefix:'Mag.'})),
                            ...(src.minDetails||[]).map(d=>({...d,prefix:'Min.'}))];
        allDetails.forEach(d => {
            const ic = critIcon(d.met !== undefined ? d.met : d.met);
            h += `<div class="crit-row">
                <span class="crit-icon ${ic.cls}">${ic.sym}</span>
                <span>${d.label || d.text || ''}</span>
            </div>`;
        });
        h += '</div>';
    }

    // ICC warning
    if (who.pre.dx.includes('CONFERMATO') || who.pre.dx.includes('PROBABILE')) {
        h += `<div class="icc-chip" style="margin-top:10px;">
            ‚ö† Pre-PMF: entit√† WHO 2022, non formalizzata allo stesso modo in ICC 2022
        </div>`;
    }
    if (who.pre.tripleNeg || who.et.dx.includes('PROBABILE')) {
        h += `<div class="icc-chip">
            ‚ö† Triple-neg: ICC 2022 richiede clonalit√† alternativa documentata
        </div>`;
    }

    return h;
}

function renderMorfoPanel(morfo) {
    let h = '';
    const colors = { ET:'var(--who-color)', PV:'#ec4899', PrePMF:'var(--morfo-color)', PMF:'var(--mol-color)' };
    h += '<div class="score-bar-row">';
    morfo.ranked.forEach(([name, score]) => {
        const pct = Math.min(score, 100);
        const color = colors[name] || 'var(--text-muted)';
        h += `<div class="score-item">
            <div class="score-item-label">
                <span>${name}</span>
                <span style="color:${color};font-weight:600;">${score}</span>
            </div>
            <div class="score-bar-bg">
                <div class="score-bar-fill" style="width:${pct}%;background:${color};"></div>
            </div>
        </div>`;
    });
    h += '</div>';

    // Top reasoning
    const top = morfo.ranked[0][0];
    const reas = morfo.reasoning[top];
    if (reas && reas.length) {
        h += '<div class="criteria-detail">';
        h += `<div class="criteria-label">${top} ‚Äî razionale</div>`;
        reas.slice(0,6).forEach(r => {
            const pos = r.p > 0;
            h += `<div class="crit-row">
                <span class="crit-icon ${pos?'met':'not-met'}">${pos?'+':r.p}</span>
                <span>${r.t}</span>
            </div>`;
        });
        h += '</div>';
    }
    return h;
}

function renderMolPanel(mol) {
    let h = '';
    if (mol.molBias) {
        h += `<div style="padding:8px 10px;background:var(--surface2);border-radius:4px;margin-bottom:12px;border:1px solid var(--border);">
            <div style="font-family:'IBM Plex Mono',monospace;font-size:0.7em;color:var(--text-muted);margin-bottom:4px;">ORIENTAMENTO MOLECOLARE</div>
            <div style="color:${mol.molBias.color};font-weight:600;font-size:0.85em;">${mol.molBias.label}</div>
            <div style="font-size:0.78em;color:var(--text-dim);margin-top:2px;">${mol.molBias.dx}</div>
        </div>`;
    }
    mol.items.forEach(item => {
        const cls = item.type === 'pos' ? 'mol-pos' : item.type === 'partial' ? 'mol-partial' : 'mol-neg';
        h += `<div class="mol-item">
            <div>
                <div style="font-weight:500;color:var(--text);">${item.label}</div>
                <div style="font-size:0.72em;color:var(--text-muted);margin-top:2px;">${item.note}</div>
            </div>
            <div>
                <span class="mol-badge ${cls}">${item.value}</span>
                ${item.bias !== '‚Äî' ? `<div style="font-size:0.65em;color:var(--text-muted);text-align:right;margin-top:2px;">${item.bias}</div>` : ''}
            </div>
        </div>`;
    });
    return h;
}

// ============================================================================
// MAIN
// ============================================================================
function toggleLab() {
    const body = document.getElementById('lab-body');
    const icon = document.getElementById('lab-toggle-icon');
    const collapsed = body.style.display === 'none';
    body.style.display = collapsed ? 'block' : 'none';
    icon.textContent = collapsed ? '‚ñæ' : '‚ñ∏';
}

function updateTripleNeg() {
    const allNeg = ['jak2','calr','mpl'].every(id => document.getElementById(id).value === 'neg');
    document.getElementById('triple-neg-banner').style.display = allNeg ? 'block' : 'none';
}

function analyzeCase() {
    const req = ['cellularity','megakaryocyte','proliferation'];
    for (let f of req) {
        if (!document.getElementById(f).value) {
            alert('Campi obbligatori: cellularit√†, megacariociti, proliferazione');
            return;
        }
    }

    const data     = collectData();
    const who      = runWHOFormal(data);
    const morfo    = runPatternMorfo(data);
    const mol      = runClinMol(data);
    const redFlags = detectRedFlags(data);
    const discords = detectDiscordance(who, morfo, mol, data);
    const mpnu     = checkMPNU(who, redFlags);
    const report   = generateReport(data, who, morfo, mol, discords, redFlags, mpnu);

    let html = '';

    // Red flags
    if (redFlags.length) {
        html += '<div class="redflag-area">';
        redFlags.forEach(f => {
            html += `<div class="redflag-item">
                <div class="redflag-title">üö® ${f.title}</div>
                <div class="redflag-msg">${f.msg}</div>
                <div class="redflag-action">‚Üí ${f.action}</div>
            </div>`;
        });
        html += '</div>';
    }

    // Discordance banners
    discords.forEach(d => {
        html += `<div class="discord-banner">
            <div class="discord-header">
                <span class="discord-icon">‚ö°</span>
                <span class="discord-title">Discordanza ‚Äî ${d.title}</span>
            </div>
            <div class="discord-detail">${d.detail}</div>
            <span class="discord-action">‚Üí ${d.action}</span>
        </div>`;
    });

    // MPN-U
    if (mpnu) {
        html += `<div class="mpnu-banner">
            <div class="mpnu-title">‚ö† NMC Non Classificabile (MPN-U)</div>
            <ul class="mpnu-list">
                ${mpnu.recs.map(r=>`<li>${r}</li>`).join('')}
            </ul>
        </div>`;
    }

    // Missing fibrosis warning
    if (data.fibrosis === null) {
        html += `<div class="discord-banner" style="border-color:#fcd34d;background:#fffbeb;">
            <div class="discord-header">
                <span class="discord-icon">‚ö†</span>
                <span class="discord-title" style="color:var(--warning);">Fibrosi non valutata</span>
            </div>
            <div class="discord-detail">La fibrosi √® il criterio discriminante principale tra Pre-PMF, PMF overt ed ET. Senza grading MF la classificazione √® parziale.</div>
            <span class="discord-action" style="color:var(--warning);background:#fef9c3;">‚Üí Colorazione reticolare (Gomori) raccomandata</span>
        </div>`;
    }

    // Missing lab warning
    const labPresent = [data.hb, data.hct, data.plt, data.wbc].some(v => v !== null && v !== undefined && v !== '');
    if (!labPresent) {
        html += `<div class="discord-banner" style="border-color:#d97706;background:#fffbeb;">
            <div class="discord-header">
                <span class="discord-icon">‚ö†</span>
                <span class="discord-title" style="color:#d97706;">Dati clinico-lab non disponibili</span>
            </div>
            <div class="discord-detail">La classificazione WHO 2022 richiede correlazione con emocromo completo, dati molecolari e clinica. La valutazione morfologica isolata √® necessariamente parziale.</div>
            <span class="discord-action" style="color:#d97706;background:#fef3c7;">‚Üí Indispensabile confronto clinico-ematologico per diagnosi definitiva</span>
        </div>`;
    } else if (![data.hb, data.plt, data.wbc].every(v => v !== null && v !== undefined && v !== '')) {
        html += `<div class="discord-banner" style="border-color:#d97706;background:#fffbeb;">
            <div class="discord-header">
                <span class="discord-icon">‚óê</span>
                <span class="discord-title" style="color:#d97706;">Dati clinico-lab parziali</span>
            </div>
            <div class="discord-detail">Alcuni parametri chiave (Hb, PLT, WBC) non sono stati inseriti. La classificazione √® orientativa.</div>
            <span class="discord-action" style="color:#d97706;background:#fef3c7;">‚Üí Valutazione nel contesto clinico completo</span>
        </div>`;
    }

    // Tri-modal grid
    html += '<div class="board-title">‚óà Collegio Ematologico ‚Äî Tre Prospettive Parallele</div>';
    html += `<div class="trimodal-grid">
        <div class="modal-panel who-panel">
            <div class="modal-header">
                <div class="modal-dot"></div>
                <span class="modal-title">WHO 2022 Formale</span>
            </div>
            ${renderWHOPanel(who)}
        </div>
        <div class="modal-panel morfo-panel">
            <div class="modal-header">
                <div class="modal-dot"></div>
                <span class="modal-title">Quadro Morfologico</span>
            </div>
            ${renderMorfoPanel(morfo)}
        </div>
        <div class="modal-panel mol-panel">
            <div class="modal-header">
                <div class="modal-dot"></div>
                <span class="modal-title">Clinico-Molecolare</span>
            </div>
            ${renderMolPanel(mol)}
        </div>
    </div>`;

    // Report
    html += `<div class="report-section">
        <div class="report-header">
            <span class="report-header-title">‚óà Referto Strutturato</span>
            <button class="copy-btn" onclick="copyReport()">‚éò Copia</button>
        </div>
        <div class="report-body" id="report-body">${report}</div>
    </div>`;

    document.getElementById('empty-state').style.display = 'none';
    document.getElementById('result-area').style.display = 'block';
    document.getElementById('result-area').innerHTML = html;
}

function copyReport() {
    const text = document.getElementById('report-body').textContent;
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.textContent = '‚úì Copiato';
        setTimeout(() => btn.textContent = '‚éò Copia', 2000);
    });
}

function resetForm() {
    if (!confirm('Sbloccare nuovo caso?\nTutti i dati del caso corrente verranno cancellati.')) return;
    document.querySelectorAll('input,select,textarea').forEach(el => {
        if (el.type === 'checkbox') el.checked = false;
        else if (el.tagName === 'SELECT') el.selectedIndex = 0;
        else el.value = '';
    });
    document.getElementById('lab-body').style.display = 'block';
    document.getElementById('lab-toggle-icon').textContent = '‚ñæ';
    document.getElementById('triple-neg-banner').style.display = 'none';
    document.getElementById('cellularity-hint').textContent = '';
    document.getElementById('empty-state').style.display = 'flex';
    document.getElementById('result-area').style.display = 'none';
    document.getElementById('result-area').innerHTML = '';
}
</script>
</body>
</html>
