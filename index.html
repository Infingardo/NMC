<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NMC Diagnostic Tool - Pattern Recognition & WHO 2022</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.95em;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            flex-wrap: wrap;
        }
        
        .tab {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            color: #667eea;
            background: white;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .section.required {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .badge {
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: 600;
        }
        
        .badge-required {
            background: #dc3545;
            color: white;
        }
        
        .badge-who {
            background: #17a2b8;
            color: white;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        input[type="number"], input[type="text"], input[type="date"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .button-group button {
            flex: 1;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }
        
        .result {
            margin-top: 30px;
            padding: 25px;
            border-radius: 8px;
            display: none;
        }
        
        .result.show {
            display: block;
        }
        
        .result h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .alert {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .alert-critical {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        
        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .pattern-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        
        .pattern-box.who-box {
            border-left-color: #17a2b8;
            background: #f0f9fb;
        }
        
        .pattern-box h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .pattern-box.who-box h4 {
            color: #17a2b8;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .confidence-meter {
            display: flex;
            gap: 5px;
            margin: 15px 0;
        }
        
        .confidence-bar {
            height: 10px;
            flex: 1;
            background: #dee2e6;
            border-radius: 4px;
        }
        
        .confidence-bar.filled {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .report-text {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            white-space: pre-wrap;
            border: 2px solid #dee2e6;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .copy-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            padding: 8px 15px;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .info-text {
            font-size: 0.85em;
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }
        
        .scoring-detail {
            background: white;
            padding: 12px;
            margin: 10px 0;
            border-left: 3px solid #667eea;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .scoring-positive {
            border-left-color: #28a745;
        }
        
        .scoring-negative {
            border-left-color: #dc3545;
        }
        
        .who-criteria {
            background: white;
            padding: 10px;
            margin: 8px 0;
            border-left: 3px solid #17a2b8;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .who-criteria.met {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .who-criteria.not-met {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        
        ul {
            margin-left: 20px;
        }
        
        li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ NMC Diagnostic Tool</h1>
            <p>Pattern Recognition & WHO 2022 Formal Criteria - Pannello IHC Completo</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('input')">üìã Input Dati</div>
            <div class="tab" onclick="switchTab('results')">üìä Risultati</div>
            <div class="tab" onclick="switchTab('reference')">üìö Riferimenti</div>
        </div>
        
        <!-- TAB INPUT -->
        <div id="tab-input" class="tab-content active">
            
            <!-- DATI ANAGRAFICI -->
            <div class="section" style="background: #e8f4f8; border-left-color: #17a2b8;">
                <h2>üë§ Dati Paziente</h2>
                <div class="grid">
                    <div class="input-group">
                        <label>Et√† (anni):</label>
                        <input type="number" id="age" min="0" max="120" placeholder="Es: 65">
                    </div>
                    <div class="input-group">
                        <label>Sesso:</label>
                        <select id="sex">
                            <option value="">-- Seleziona --</option>
                            <option value="M">Maschio</option>
                            <option value="F">Femmina</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- ISTOLOGIA - OBBLIGATORIO -->
            <div class="section required">
                <h2>üî¨ Valutazione Istologica <span class="badge badge-required">OBBLIGATORIO</span></h2>
                
                <h3 style="margin-top: 10px; font-size: 1em; color: #333;">Cellularit√† (WHO 2022)</h3>
                <div class="grid">
                    <div class="input-group">
                        <label>Cellularit√† (%):</label>
                        <input type="number" id="cellularity-percent" min="0" max="100" step="5" placeholder="Es: 80">
                        <p class="info-text" id="cellularity-hint">Inserisci et√† per range atteso</p>
                    </div>
                    <div class="input-group">
                        <label>Cellularit√† vs et√†:</label>
                        <select id="cellularity">
                            <option value="">-- Seleziona --</option>
                            <option value="normal">Normale per et√†</option>
                            <option value="increased">Aumentata per et√†</option>
                            <option value="decreased">Diminuita per et√†</option>
                        </select>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1em; color: #333;">Megacariociti e Maturazione</h3>
                <div class="grid">
                    <div class="input-group">
                        <label>Morfologia megacariociti:</label>
                        <select id="megakaryocyte">
                            <option value="">-- Seleziona --</option>
                            <option value="normal">Normali</option>
                            <option value="hyperlobulated">Iperlobulati, maturi, grandi (ET-pattern)</option>
                            <option value="clustered">Clustering denso con atipia (PMF-pattern)</option>
                            <option value="pleomorphic">Pleomorfi, varie taglie (PV-pattern)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Proliferazione midollare:</label>
                        <select id="proliferation">
                            <option value="">-- Seleziona --</option>
                            <option value="minimal">Minima/Normale</option>
                            <option value="megakaryocytic">Prevalentemente megacariocitica</option>
                            <option value="granulocytic">Prevalentemente granulocitaria</option>
                            <option value="panmyelosis">Panmielosi (E+G+M)</option>
                            <option value="erythroid">Prevalentemente eritroide</option>
                        </select>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1em; color: #333;">Parametri Quantitativi</h3>
                <div class="grid">
                    <div class="input-group">
                        <label>Rapporto M/E:</label>
                        <select id="me_ratio">
                            <option value="">-- Non valutato --</option>
                            <option value="normal">Normale (2-4:1)</option>
                            <option value="increased">Aumentato (>4:1)</option>
                            <option value="decreased">Ridotto (<2:1)</option>
                            <option value="inverted">Invertito (<1:1)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Fibrosi reticolare (MF-grading):</label>
                        <select id="fibrosis">
                            <option value="">-- Seleziona --</option>
                            <option value="0">MF-0: Assente</option>
                            <option value="1">MF-1: Minima</option>
                            <option value="2">MF-2: Moderata</option>
                            <option value="3">MF-3: Marcata</option>
                        </select>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 1em; color: #333;">Componente Linfoide</h3>
                <div class="grid-2">
                    <div class="input-group">
                        <label>Componente linfoide (%):</label>
                        <input type="number" id="lymphoid-percent" min="0" max="100" step="1" placeholder="Es: 15">
                        <p class="info-text">Normale <20%</p>
                    </div>
                    <div class="input-group">
                        <label>Distribuzione linfoide:</label>
                        <select id="lymphoid-distribution">
                            <option value="">-- Seleziona --</option>
                            <option value="normal">Sparsa, normale</option>
                            <option value="paratrabecular">Paratrabecolari</option>
                            <option value="interstitial">Interstiziale diffusa</option>
                            <option value="nodular">Noduli/follicoli</option>
                            <option value="sheets">A tappeto (SOSPETTO LINFOMA)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- IMMUNOISTOCHIMICA -->
            <div class="section">
                <h2>üß™ Immunoistochimica - Pannello Laboratorio <span class="badge badge-required">OBBLIGATORIO</span></h2>
                
                <h3 style="margin-top: 10px; font-size: 0.95em; color: #333;">Linea Eritroide</h3>
                <div class="input-group">
                    <label>E-caderina (eritroblasti immaturi):</label>
                    <select id="ecadherin">
                        <option value="">-- Non eseguito --</option>
                        <option value="negative">Negativo/assente</option>
                        <option value="focal">Positivo focale (normale)</option>
                        <option value="increased">Aumentato (eritropoiesi accelerata)</option>
                        <option value="absent">Assente (eritropoiesi ridotta)</option>
                    </select>
                    <p class="info-text">CRITICO per PV: aumentato = eritropoiesi accelerata</p>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 0.95em; color: #333;">Linea Granulocitaria</h3>
                <div class="grid">
                    <div class="input-group">
                        <label>MPO (mieloperossidasi):</label>
                        <select id="mpo">
                            <option value="">-- Non eseguito --</option>
                            <option value="normal">Maturazione normale</option>
                            <option value="shift">Shift a sinistra (forme immature)</option>
                            <option value="marked">Immaturit√† marcata</option>
                            <option value="decreased">Espressione ridotta</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>CD15 (granulociti maturi):</label>
                        <select id="cd15">
                            <option value="">-- Non eseguito --</option>
                            <option value="normal">Positivo normale (granulociti maturi)</option>
                            <option value="weak">Debolmente positivo</option>
                            <option value="negative">Negativo (sospetto AML)</option>
                            <option value="reduced">Ridotto</option>
                        </select>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 0.95em; color: #333;">Linea Monocitica (PANNELLO FONDAMENTALE)</h3>
                
                <div class="alert alert-info" style="margin-bottom: 15px;">
                    <strong>üìå KP1 vs PG-M1 (entrambi sono CD68):</strong>
                    <ul style="margin-top: 10px; margin-bottom: 0;">
                        <li><strong>KP1:</strong> Epitopo citoplasmatico+membrana ‚Üí Sensibilit√† ALTA, meno specifico (prende eosinofili, mastociti) ‚Üí <strong>Screening generale</strong></li>
                        <li><strong>PG-M1:</strong> Epitopo lisosomiale intracellulare ‚Üí Specificit√† ALTA, solo macrofagi maturi ‚Üí <strong>Conta precisa macrofagi</strong></li>
                    </ul>
                </div>
                
                <div class="grid">
                    <div class="input-group">
                        <label>CD68 (KP1 o PG-M1):</label>
                        <select id="cd68">
                            <option value="">-- Non eseguito --</option>
                            <option value="negative">Negativo/raro</option>
                            <option value="focal">Focale</option>
                            <option value="moderate">Moderato</option>
                            <option value="strong">Fortemente positivo (diffuso)</option>
                        </select>
                        <p class="info-text">Interpretare stessa manera. Se usi PG-M1: solo macrofagi differenziati. Se usi KP1: include precursori monocitici</p>
                    </div>
                    <div class="input-group">
                        <label>CD14 (monociti):</label>
                        <select id="cd14">
                            <option value="">-- Non eseguito --</option>
                            <option value="negative">Negativo (immaturi)</option>
                            <option value="weak">Debolmente positivo</option>
                            <option value="moderate">Moderatamente positivo</option>
                            <option value="strong">Fortemente positivo (maturi)</option>
                        </select>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>CD163 (macrofagi MATURI):</label>
                    <select id="cd163">
                        <option value="">-- Non eseguito --</option>
                        <option value="negative">Negativo (blasti/immaturi)</option>
                        <option value="weak">Debolmente positivo (promonociti)</option>
                        <option value="moderate">Moderatamente positivo</option>
                        <option value="strong">Fortemente positivo (macrofagi maturi)</option>
                    </select>
                    <p class="info-text">‚ö†Ô∏è Solo macrofagi MATURI. Negativo su monoblasti</p>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 0.95em; color: #333;">Linea Megacariocitica</h3>
                <div class="input-group">
                    <label>CD61 (GPIIIa, megacariociti):</label>
                    <select id="cd61">
                        <option value="">-- Non eseguito --</option>
                        <option value="normal">Megacariociti normali</option>
                        <option value="increased">Megacariociti aumentati</option>
                        <option value="clustered">Clustering marcato</option>
                        <option value="atypical">Forme atipiche/displastiche</option>
                    </select>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 0.95em; color: #333;">Linea Linfoide</h3>
                <div class="grid">
                    <div class="input-group">
                        <label>CD3 (linfociti T):</label>
                        <select id="cd3">
                            <option value="">-- Non eseguito --</option>
                            <option value="normal">Normale (<20%)</option>
                            <option value="increased">Aumentati (>20%)</option>
                            <option value="aggregates">Aggregati T</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>CD20 (linfociti B):</label>
                        <select id="cd20">
                            <option value="">-- Non eseguito --</option>
                            <option value="normal">Normale (<20%)</option>
                            <option value="increased">Aumentati (>20%)</option>
                            <option value="aggregates">Aggregati B/follicoli</option>
                        </select>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 0.95em; color: #333;">Linea Plasmacellulare</h3>
                <div class="grid">
                    <div class="input-group">
                        <label>CD138 (plasmacellule):</label>
                        <select id="cd138">
                            <option value="">-- Non eseguito --</option>
                            <option value="normal">Normale (<5%)</option>
                            <option value="increased">Aumentate (5-10%)</option>
                            <option value="high">Alte (>10%, sospetto mieloma)</option>
                            <option value="clusters">Aggregati plasmacellulari</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="kl_performed" onchange="toggleKL()">
                            <label for="kl_performed">Rapporto Kappa/Lambda eseguito</label>
                        </div>
                        <select id="kappa_lambda" style="display: none; margin-top: 10px;">
                            <option value="">-- Seleziona risultato --</option>
                            <option value="normal">Normale (0.48-3.0, policlonale)</option>
                            <option value="kappa">Eccesso Kappa (>3.0, monoclonale)</option>
                            <option value="lambda">Eccesso Lambda (<0.48, monoclonale)</option>
                            <option value="severe">Fortemente alterato (<0.14 o >7)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- DATI CLINICI E LABORATORISTICI -->
            <div class="section">
                <h2>ü©∫ Dati Clinici e Laboratoristici</h2>
                
                <h3 style="margin-top: 10px; font-size: 0.95em; color: #333;">Data e Quesito</h3>
                <div class="grid">
                    <div class="input-group">
                        <label>Data biopsia:</label>
                        <input type="date" id="biopsy-date">
                    </div>
                    <div class="input-group">
                        <label>Quesito clinico:</label>
                        <input type="text" id="clinical-question" placeholder="Es: sospetta ET, escludere PMF">
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 0.95em; color: #333;">Blasti e Conta Differenziale Midollare</h3>
                <div class="grid">
                    <div class="input-group">
                        <label>Blasti (%):</label>
                        <input type="number" id="blasts-percent" min="0" max="100" step="1" placeholder="Es: 2.5">
                        <p class="info-text">‚ö†Ô∏è Critico per escludere AML (>20%) e trasformazione blastica (>10% in NMC)</p>
                    </div>
                    <div class="input-group">
                        <label>Monociti periferici assoluti (√ó10‚Åπ/L):</label>
                        <input type="number" id="monocytes-absolute" step="0.1" min="0" max="100" placeholder="Es: 1.5">
                        <p class="info-text">‚ö†Ô∏è CRITICO per diagnosi LMMC: >1√ó10‚Åπ/L + CD68++/CD14++ = LMMC confermato</p>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 0.95em; color: #333;">Morfologia Midollare - Note Aggiuntive</h3>
                <div class="input-group">
                    <label>Note morfologiche (displasia, dacriociti, anomalie, etc.):</label>
                    <textarea id="morphology-notes" placeholder="Es: displasia eritroide lieve, dacriociti presenti, neutrofili con ipersegmentazione, ecc."></textarea>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 0.95em; color: #333;">Emocromo</h3>
                <div class="grid">
                    <div class="input-group">
                        <label>Emoglobina (g/dL):</label>
                        <input type="number" id="hb" step="0.1" min="0" max="25" placeholder="Es: 14.5">
                    </div>
                    <div class="input-group">
                        <label>Ematocrito (%):</label>
                        <input type="number" id="hct" step="0.1" min="0" max="100" placeholder="Es: 42">
                    </div>
                    <div class="input-group">
                        <label>Piastrine (√ó10‚Åπ/L):</label>
                        <input type="number" id="plt" min="0" max="5000" placeholder="Es: 650">
                    </div>
                    <div class="input-group">
                        <label>Leucociti (√ó10‚Åπ/L):</label>
                        <input type="number" id="wbc" step="0.1" min="0" max="500" placeholder="Es: 12.5">
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 0.95em; color: #333;">Profilo Molecolare</h3>
                <div class="grid">
                    <div class="checkbox-group">
                        <input type="checkbox" id="jak2">
                        <label for="jak2">JAK2 V617F positivo</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="calr">
                        <label for="calr">CALR mutato</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="mpl">
                        <label for="mpl">MPL mutato</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="triple_neg">
                        <label for="triple_neg">Triple-negative</label>
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 0.95em; color: #333;">Citogenetica e FISH (se eseguiti)</h3>
                <div class="grid-2">
                    <div class="input-group">
                        <label>Risultati citogenetica:</label>
                        <select id="cytogenetics">
                            <option value="">-- Non eseguita --</option>
                            <option value="normal">Normale 46,XX/XY</option>
                            <option value="del5q">del(5q)</option>
                            <option value="trisomy8">Trisomia 8</option>
                            <option value="del20q">del(20q)</option>
                            <option value="t9_22">t(9;22) - BCR/ABL (CML)</option>
                            <option value="complex">Cariotipo complesso (>3 anomalie)</option>
                            <option value="other">Altra anomalia (specificare)</option>
                        </select>
                        <p class="info-text">Esclude CML, supporta diagnosi MDS se anomalie</p>
                    </div>
                    <div class="input-group">
                        <label>Note citogenetica aggiuntive:</label>
                        <input type="text" id="cytogenetics-notes" placeholder="Es: monosomia 7, inv(3), ecc.">
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; font-size: 0.95em; color: #333;">Segni Clinici</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="splenomegaly">
                    <label for="splenomegaly">Splenomegalia</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="symptoms">
                    <label for="symptoms">Sintomi costituzionali</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="anemia">
                    <label for="anemia">Anemia (WHO PMF)</label>
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <label>LDH:</label>
                    <select id="ldh">
                        <option value="">-- Non valutato --</option>
                        <option value="normal">Normale</option>
                        <option value="elevated">Elevato</option>
                    </select>
                </div>
            </div>
            
            <div class="button-group">
                <button onclick="analyzeCase()">üîç Analizza Caso</button>
                <button class="btn-secondary" onclick="resetForm()">üîÑ Reset</button>
            </div>
        </div>
        
        <!-- TAB RISULTATI -->
        <div id="tab-results" class="tab-content">
            <div id="result-area"></div>
        </div>
        
        <!-- TAB RIFERIMENTI -->
        <div id="tab-reference" class="tab-content">
            <h2>üìö Riferimenti Diagnostici</h2>
            
            <div class="pattern-box">
                <h4>Range Cellularit√† WHO 2022</h4>
                <table>
                    <tr>
                        <th>Fascia Et√†</th>
                        <th>Range (%)</th>
                        <th>Media (%)</th>
                    </tr>
                    <tr>
                        <td><2 anni</td>
                        <td>45-85</td>
                        <td>79.8</td>
                    </tr>
                    <tr>
                        <td>2-5 anni</td>
                        <td>50-70</td>
                        <td>59.1</td>
                    </tr>
                    <tr>
                        <td><20 anni</td>
                        <td>45-85</td>
                        <td>65</td>
                    </tr>
                    <tr>
                        <td>20-40 anni</td>
                        <td>40-70</td>
                        <td>55</td>
                    </tr>
                    <tr>
                        <td>40-60 anni</td>
                        <td>35-65</td>
                        <td>50</td>
                    </tr>
                    <tr>
                        <td>60-70 anni</td>
                        <td>30-60</td>
                        <td>45</td>
                    </tr>
                    <tr style="background: #fff3cd;">
                        <td>>70 anni</td>
                        <td>30-60</td>
                        <td>45 (STABILE)</td>
                    </tr>
                </table>
            </div>
            
            <div class="pattern-box">
                <h4>Pattern NMC secondo WHO 2022</h4>
                <table>
                    <tr>
                        <th>Diagnosi</th>
                        <th>Megacariociti</th>
                        <th>Proliferazione</th>
                        <th>Fibrosi</th>
                        <th>M/E</th>
                    </tr>
                    <tr>
                        <td><strong>ET</strong></td>
                        <td>Iperlobulati, maturi</td>
                        <td>Megacariocitica</td>
                        <td>MF-0/1</td>
                        <td>Normale</td>
                    </tr>
                    <tr>
                        <td><strong>PV</strong></td>
                        <td>Pleomorfi</td>
                        <td>Panmielosi</td>
                        <td>MF-0/1</td>
                        <td>Ridotto/invertito</td>
                    </tr>
                    <tr>
                        <td><strong>PMF</strong></td>
                        <td>Clustering + atipia</td>
                        <td>Variabile</td>
                        <td>MF-2/3</td>
                        <td>Aumentato</td>
                    </tr>
                    <tr>
                        <td><strong>Pre-PMF</strong></td>
                        <td>Clustering</td>
                        <td>Variabile</td>
                        <td>MF-0/1</td>
                        <td>Variabile</td>
                    </tr>
                </table>
            </div>
            
            <div class="pattern-box who-box">
                <h4>Criteri WHO 2022 - Policitemia Vera</h4>
                <p><strong>Diagnosi: ‚â•2 criteri maggiori O 1 maggiore + 1 minore</strong></p>
                <p><strong>Criteri Maggiori:</strong></p>
                <ul>
                    <li>Hb >16.5 g/dL (M) o >16.0 g/dL (F), oppure Hct >49% (M) o >48% (F)</li>
                    <li>Biopsia: panmielosi con megacariociti pleomorfi</li>
                    <li>JAK2 V617F o mutazione esone 12</li>
                </ul>
                <p><strong>Criterio Minore:</strong></p>
                <ul>
                    <li>Eritropoietina subnormale</li>
                </ul>
            </div>
            
            <div class="pattern-box who-box">
                <h4>Criteri WHO 2022 - Trombocitemia Essenziale</h4>
                <p><strong>Diagnosi: Tutti e 4 i criteri devono essere soddisfatti</strong></p>
                <ol>
                    <li>Piastrine ‚â•450 √ó10‚Åπ/L</li>
                    <li>Biopsia: megacariociti iperlobulati maturi</li>
                    <li>Esclusione PV, PMF, CML, MDS</li>
                    <li>Mutazione JAK2, CALR o MPL</li>
                </ol>
            </div>
            
            <div class="pattern-box who-box">
                <h4>Criteri WHO 2022 - Mielofibrosi Primaria</h4>
                <p><strong>Diagnosi: ‚â•3 criteri maggiori + ‚â•1 minore</strong></p>
                <p><strong>Criteri Maggiori:</strong></p>
                <ul>
                    <li>Clustering megacariociti con atipia + fibrosi MF-2/3</li>
                    <li>Esclusione PV, ET, CML, MDS</li>
                    <li>Mutazione JAK2, CALR, MPL o altra mutazione clonale</li>
                </ul>
                <p><strong>Criteri Minori:</strong></p>
                <ul>
                    <li>Anemia</li>
                    <li>Leucocitosi ‚â•11 √ó10‚Åπ/L</li>
                    <li>Splenomegalia palpabile</li>
                    <li>LDH elevato</li>
                    <li>Leucoeritroblastosi</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ALGORITMI DIAGNOSTICI INTEGRATI -->
    <script>
        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const tabMap = { input: 0, results: 1, reference: 2 };
            document.querySelectorAll('.tab')[tabMap[tab]].classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }
        
        function toggleKL() {
            const checkbox = document.getElementById('kl_performed');
            const select = document.getElementById('kappa_lambda');
            select.style.display = checkbox.checked ? 'block' : 'none';
            if (!checkbox.checked) select.value = '';
        }
        
        function updateCellularityHint() {
            const age = parseInt(document.getElementById('age').value);
            const cellularityPercent = document.getElementById('cellularity-percent').value;
            const hintElement = document.getElementById('cellularity-hint');
            const cellularitySelect = document.getElementById('cellularity');
            
            function getCellularityRange(age) {
                if (age < 2) return { min: 45, max: 85, mean: 79.8, label: '<2 anni (fisiologicamente ipercellulare)' };
                if (age < 5) return { min: 50, max: 70, mean: 59.1, label: '2-5 anni' };
                if (age < 20) return { min: 45, max: 85, mean: 65, label: '<20 anni' };
                if (age < 40) return { min: 40, max: 70, mean: 55, label: '20-40 anni' };
                if (age < 60) return { min: 35, max: 65, mean: 50, label: '40-60 anni' };
                if (age < 70) return { min: 30, max: 60, mean: 45, label: '60-70 anni' };
                return { min: 30, max: 60, mean: 45, label: '>70 anni (STABILE)' };
            }
            
            if (age && age > 0 && age <= 120) {
                const range = getCellularityRange(age);
                
                if (cellularityPercent && cellularityPercent > 0) {
                    const percent = parseFloat(cellularityPercent);
                    let assessment = '', color = '', autoValue = '';
                    
                    if (percent >= range.min && percent <= range.max) {
                        assessment = '‚úì NORMALE'; color = '#28a745'; autoValue = 'normal';
                    } else if (percent > range.max) {
                        assessment = '‚¨ÜÔ∏è AUMENTATA'; color = '#dc3545'; autoValue = 'increased';
                    } else {
                        assessment = '‚¨áÔ∏è DIMINUITA'; color = '#ffc107'; autoValue = 'decreased';
                    }
                    
                    hintElement.innerHTML = `<strong>${range.label}:</strong> ${range.min}-${range.max}% (media ${range.mean}%)<br><strong style="color: ${color};">${assessment}</strong>`;
                    cellularitySelect.value = autoValue;
                    cellularitySelect.style.borderColor = color;
                    cellularitySelect.style.borderWidth = '3px';
                } else {
                    hintElement.innerHTML = `<strong>${range.label}:</strong> ${range.min}-${range.max}% (media ${range.mean}%)`;
                    cellularitySelect.style.borderColor = '#ddd';
                    cellularitySelect.style.borderWidth = '2px';
                }
            } else {
                hintElement.textContent = 'Inserisci et√† per range cellularit√† WHO 2022';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('age').addEventListener('input', updateCellularityHint);
            document.getElementById('cellularity-percent').addEventListener('input', updateCellularityHint);
        });
        
        // ============================================================================
        // SCORING WHO 2022 FORMAL CRITERIA
        // ============================================================================
        
        function calculateWHOPVScore(data) {
            let majorCriteria = 0;
            let minorCriteria = 0;
            let details = [];
            
            // CRITERIO MAGGIORE 1: Emoglobina/ematocrito
            const hbThreshold = data.sex === 'M' ? 16.5 : 16.0;
            const hctThreshold = data.sex === 'M' ? 49 : 48;
            
            if ((data.hb && data.hb > hbThreshold) || (data.hct && data.hct > hctThreshold)) {
                majorCriteria++;
                details.push({
                    criterion: 'Maggiore 1',
                    met: true,
                    text: `Hb/Hct >soglia (Hb: ${data.hb || 'N/A'} g/dL, Hct: ${data.hct || 'N/A'}%)`
                });
            } else {
                details.push({
                    criterion: 'Maggiore 1',
                    met: false,
                    text: `Hb/Hct ‚â§soglia (soglie: Hb >${hbThreshold}, Hct >${hctThreshold}%)`
                });
            }
            
            // CRITERIO MAGGIORE 2: Biopsia (panmielosi + megacariociti pleomorfi)
            if (data.proliferation === 'panmyelosis' && data.megakaryocyte === 'pleomorphic') {
                majorCriteria++;
                details.push({
                    criterion: 'Maggiore 2',
                    met: true,
                    text: 'Biopsia: panmielosi con megacariociti pleomorfi'
                });
            } else {
                details.push({
                    criterion: 'Maggiore 2',
                    met: false,
                    text: 'Biopsia non soddisfa criteri (panmielosi + pleomorfi richiesti)'
                });
            }
            
            // CRITERIO MAGGIORE 3: Mutazione JAK2
            if (data.jak2) {
                majorCriteria++;
                details.push({
                    criterion: 'Maggiore 3',
                    met: true,
                    text: 'JAK2 V617F positivo'
                });
            } else {
                details.push({
                    criterion: 'Maggiore 3',
                    met: false,
                    text: 'JAK2 negativo o non testato'
                });
            }
            
            // CRITERIO MINORE: EPO subnormale (non disponibile nel form, quindi non valutabile)
            details.push({
                criterion: 'Minore',
                met: null,
                text: 'Eritropoietina: non valutabile (dato non disponibile)'
            });
            
            // DIAGNOSI PV: ‚â•2 maggiori O 1 maggiore + 1 minore
            const diagnosis = (majorCriteria >= 2) || (majorCriteria >= 1 && minorCriteria >= 1);
            
            return {
                diagnosis: diagnosis ? "PV_CONFERMATO" : "PV_ESCLUSO",
                majorCriteria,
                minorCriteria,
                totalMajor: 3,
                totalMinor: 1,
                details,
                summary: `Criteri maggiori: ${majorCriteria}/3, Criteri minori: ${minorCriteria}/1`
            };
        }
        
        function calculateWHOETScore(data) {
            const criteria = [];
            let metCount = 0;
            
            // Criterio 1: Piastrine ‚â•450 √ó10‚Åπ/L
            if (data.plt && data.plt >= 450) {
                metCount++;
                criteria.push({
                    number: 1,
                    met: true,
                    text: `Piastrine ${data.plt} √ó10‚Åπ/L (‚â•450)`
                });
            } else {
                criteria.push({
                    number: 1,
                    met: false,
                    text: `Piastrine ${data.plt || 'N/A'} √ó10‚Åπ/L (richiesto ‚â•450)`
                });
            }
            
            // Criterio 2: Biopsia - megacariociti iperlobulati
            if (data.megakaryocyte === 'hyperlobulated') {
                metCount++;
                criteria.push({
                    number: 2,
                    met: true,
                    text: 'Biopsia: megacariociti iperlobulati maturi'
                });
            } else {
                criteria.push({
                    number: 2,
                    met: false,
                    text: 'Biopsia: morfologia megacariociti non ET-pattern'
                });
            }
            
            // Criterio 3: Esclusione PV, PMF, CML, MDS
            const pvFeatures = (data.proliferation === 'panmyelosis' && data.me_ratio === 'inverted');
            const pmfFeatures = (data.fibrosis >= 2);
            const cmlFeatures = (data.cytogenetics === 't9_22');
            const mdsFeatures = (data.blasts_percent >= 5);
            
            if (!pvFeatures && !pmfFeatures && !cmlFeatures && !mdsFeatures) {
                metCount++;
                criteria.push({
                    number: 3,
                    met: true,
                    text: 'Esclusione PV, PMF, CML, MDS soddisfatta'
                });
            } else {
                criteria.push({
                    number: 3,
                    met: false,
                    text: 'Presenza features di altre NMC/MDS'
                });
            }
            
            // Criterio 4: Mutazione JAK2/CALR/MPL
            if (data.jak2 || data.calr || data.mpl) {
                metCount++;
                let muts = [];
                if (data.jak2) muts.push('JAK2');
                if (data.calr) muts.push('CALR');
                if (data.mpl) muts.push('MPL');
                criteria.push({
                    number: 4,
                    met: true,
                    text: `Mutazione driver: ${muts.join(', ')}`
                });
            } else {
                criteria.push({
                    number: 4,
                    met: false,
                    text: 'Nessuna mutazione driver (JAK2/CALR/MPL)'
                });
            }
            
            return {
                diagnosis: metCount === 4 ? "ET_CONFERMATO" : "ET_NON_CONFERMATO",
                criteriaMet: metCount,
                totalCriteria: 4,
                criteria,
                summary: `Criteri soddisfatti: ${metCount}/4 (tutti e 4 richiesti per diagnosi)`
            };
        }
        
        function calculateWHOPMFScore(data) {
            let majorMet = 0;
            let minorMet = 0;
            const majorCriteria = [];
            const minorCriteria = [];
            
            // CRITERI MAGGIORI
            
            // Maggiore 1: Clustering megacariociti con atipia + fibrosi MF-2/3
            if (data.megakaryocyte === 'clustered' && data.fibrosis >= 2) {
                majorMet++;
                majorCriteria.push({
                    number: 1,
                    met: true,
                    text: `Clustering megacariociti + fibrosi MF-${data.fibrosis}`
                });
            } else {
                majorCriteria.push({
                    number: 1,
                    met: false,
                    text: 'Clustering e/o fibrosi insufficienti'
                });
            }
            
            // Maggiore 2: Esclusione PV, ET, CML, MDS
            const pvFeatures = (data.proliferation === 'panmyelosis' && data.me_ratio === 'inverted' && data.fibrosis < 2);
            const etFeatures = (data.megakaryocyte === 'hyperlobulated' && data.fibrosis < 2);
            const cmlFeatures = (data.cytogenetics === 't9_22');
            const mdsFeatures = (data.blasts_percent >= 5 && data.blasts_percent < 20);
            
            if (!pvFeatures && !etFeatures && !cmlFeatures && !mdsFeatures) {
                majorMet++;
                majorCriteria.push({
                    number: 2,
                    met: true,
                    text: 'Esclusione PV, ET, CML, MDS soddisfatta'
                });
            } else {
                majorCriteria.push({
                    number: 2,
                    met: false,
                    text: 'Presenza features di altre NMC/MDS'
                });
            }
            
            // Maggiore 3: Mutazione JAK2, CALR, MPL o altra mutazione clonale
            if (data.jak2 || data.calr || data.mpl) {
                majorMet++;
                let muts = [];
                if (data.jak2) muts.push('JAK2');
                if (data.calr) muts.push('CALR');
                if (data.mpl) muts.push('MPL');
                majorCriteria.push({
                    number: 3,
                    met: true,
                    text: `Mutazione clonale: ${muts.join(', ')}`
                });
            } else {
                majorCriteria.push({
                    number: 3,
                    met: false,
                    text: 'Nessuna mutazione driver documentata'
                });
            }
            
            // CRITERI MINORI
            
            // Minore 1: Anemia
            if (data.anemia) {
                minorMet++;
                minorCriteria.push({
                    number: 1,
                    met: true,
                    text: 'Anemia presente'
                });
            } else {
                minorCriteria.push({
                    number: 1,
                    met: false,
                    text: 'Anemia non documentata'
                });
            }
            
            // Minore 2: Leucocitosi ‚â•11 √ó10‚Åπ/L
            if (data.wbc && data.wbc >= 11) {
                minorMet++;
                minorCriteria.push({
                    number: 2,
                    met: true,
                    text: `Leucocitosi ${data.wbc} √ó10‚Åπ/L (‚â•11)`
                });
            } else {
                minorCriteria.push({
                    number: 2,
                    met: false,
                    text: `Leucocitosi ${data.wbc || 'N/A'} √ó10‚Åπ/L (richiesto ‚â•11)`
                });
            }
            
            // Minore 3: Splenomegalia
            if (data.splenomegaly) {
                minorMet++;
                minorCriteria.push({
                    number: 3,
                    met: true,
                    text: 'Splenomegalia palpabile'
                });
            } else {
                minorCriteria.push({
                    number: 3,
                    met: false,
                    text: 'Splenomegalia non documentata'
                });
            }
            
            // Minore 4: LDH elevato
            if (data.ldh_elevated) {
                minorMet++;
                minorCriteria.push({
                    number: 4,
                    met: true,
                    text: 'LDH elevato'
                });
            } else {
                minorCriteria.push({
                    number: 4,
                    met: false,
                    text: 'LDH non elevato o non valutato'
                });
            }
            
            // Minore 5: Leucoeritroblastosi (non valutabile con dati attuali)
            minorCriteria.push({
                number: 5,
                met: null,
                text: 'Leucoeritroblastosi: non valutabile (dato non disponibile)'
            });
            
            // Diagnosi: ‚â•3 maggiori + ‚â•1 minore
            const diagnosis = (majorMet >= 3 && minorMet >= 1) ? "PMF_CONFERMATO" :
                             (majorMet >= 2 || (data.fibrosis === 1 && data.megakaryocyte === 'clustered')) ? "PRE_PMF_SOSPETTO" :
                             "PMF_ESCLUSO";
            
            return {
                diagnosis,
                majorMet,
                minorMet,
                totalMajor: 3,
                totalMinor: 5,
                majorCriteria,
                minorCriteria,
                summary: `Criteri maggiori: ${majorMet}/3, Criteri minori: ${minorMet}/5 (richiesto ‚â•3 maggiori + ‚â•1 minore)`
            };
        }
        
        // ============================================================================
        // SCORING ALGORITHMS - PATTERN RECOGNITION
        // ============================================================================
        
        function calculateETScore(data) {
            let score = 0;
            let reasoning = [];
            
            if (data.megakaryocyte === 'hyperlobulated') {
                score += 35;
                reasoning.push({ text: 'Megacariociti iperlobulati maturi', points: '+35', type: 'positive' });
            }
            
            if (data.proliferation === 'megakaryocytic') {
                score += 30;
                reasoning.push({ text: 'Proliferazione megacariocitica', points: '+30', type: 'positive' });
            }
            
            if (data.fibrosis <= 1) {
                score += 25;
                reasoning.push({ text: 'Assenza fibrosi o MF-1 minima', points: '+25', type: 'positive' });
            }
            
            if (data.cd61 === 'increased') {
                score += 10;
                reasoning.push({ text: 'CD61 aumentati', points: '+10', type: 'positive' });
            }
            
            if (data.cd68 === 'negative' || data.cd68 === 'focal') {
                score += 10;
                reasoning.push({ text: 'CD68 assente/focale', points: '+10', type: 'positive' });
            }
            
            if (data.me_ratio === 'normal') {
                score += 10;
                reasoning.push({ text: 'M/E normale', points: '+10', type: 'positive' });
            } else if (data.me_ratio === 'decreased' || data.me_ratio === 'inverted') {
                score -= 20;
                reasoning.push({ text: 'M/E ridotto suggerisce PV, non ET', points: '-20', type: 'negative' });
            }
            
            if (data.cd14 === 'strong') {
                score -= 30;
                reasoning.push({ text: 'CD14 strong ‚Üí LMMC suspect', points: '-30', type: 'negative' });
            }
            
            if (data.lymphoid_percent > 20) {
                score -= 25;
                reasoning.push({ text: 'Componente linfoide aumentata', points: '-25', type: 'negative' });
            }
            
            return { score: Math.max(0, score), reasoning };
        }
        
        function calculatePVScore(data) {
            let score = 0;
            let reasoning = [];
            
            if (data.proliferation === 'panmyelosis') {
                score += 35;
                reasoning.push({ text: 'Panmielosi trilineare', points: '+35', type: 'positive' });
            }
            
            if (data.cellularity === 'increased') {
                score += 25;
                reasoning.push({ text: 'Cellularit√† aumentata per et√†', points: '+25', type: 'positive' });
            }
            
            if (data.me_ratio === 'decreased' || data.me_ratio === 'inverted') {
                score += 30;
                reasoning.push({ text: 'M/E ridotto (eritropoiesi accelerata)', points: '+30', type: 'positive' });
            }
            
            if (data.megakaryocyte === 'pleomorphic') {
                score += 20;
                reasoning.push({ text: 'Megacariociti pleomorfi', points: '+20', type: 'positive' });
            }
            
            if (data.ecadherin === 'increased') {
                score += 30;
                reasoning.push({ text: '‚úì‚úì E-CADERINA AUMENTATA (eritropoiesi accelerata)', points: '+30', type: 'positive' });
            } else if (data.ecadherin === 'absent' || data.ecadherin === 'decreased') {
                score -= 30;
                reasoning.push({ text: 'E-caderina assente ‚Üí eritropoiesi inefficace (PMF/MDS)', points: '-30', type: 'negative' });
            }
            
            if (data.jak2) {
                score += 20;
                reasoning.push({ text: '‚úì‚úì JAK2 V617F+ (chief criterion)', points: '+20', type: 'positive' });
            }
            
            if (data.hb > (data.sex === 'M' ? 16.5 : 16.0) || data.hct > (data.sex === 'M' ? 49 : 48)) {
                score += 15;
                reasoning.push({ text: 'Hb/Hct >soglia PV', points: '+15', type: 'positive' });
            }
            
            if (data.fibrosis >= 2) {
                score -= 40;
                reasoning.push({ text: 'Fibrosi marcata ‚Üí PMF, non PV', points: '-40', type: 'negative' });
            }
            
            if (data.cd68 === 'strong' && data.cd14 === 'strong') {
                score -= 50;
                reasoning.push({ text: 'CD68++/CD14++ diffuso ‚Üí LMMC', points: '-50', type: 'negative' });
            }
            
            return { score: Math.max(0, score), reasoning };
        }
        
        function calculatePMFScore(data) {
            let score = 0;
            let reasoning = [];
            
            if (data.megakaryocyte === 'clustered') {
                score += 35;
                reasoning.push({ text: 'Clustering megacariociti con atipia', points: '+35', type: 'positive' });
            }
            
            if (data.fibrosis >= 2) {
                score += 40;
                reasoning.push({ text: `Fibrosi marcata MF-${data.fibrosis}`, points: '+40', type: 'positive' });
            }
            
            if (data.cd61 === 'clustered' || data.cd61 === 'atypical') {
                score += 15;
                reasoning.push({ text: 'CD61 clustering/atipie', points: '+15', type: 'positive' });
            }
            
            if (data.me_ratio === 'increased') {
                score += 15;
                reasoning.push({ text: 'M/E aumentato (eritropoiesi inefficace)', points: '+15', type: 'positive' });
            }
            
            if (data.ecadherin === 'absent' || data.ecadherin === 'decreased') {
                score += 20;
                reasoning.push({ text: 'E-caderina ridotto (eritropoiesi inefficace PMF)', points: '+20', type: 'positive' });
            }
            
            if (data.fibrosis === 0 || (data.fibrosis === 1 && data.cd61 !== 'clustered')) {
                score -= 40;
                reasoning.push({ text: 'Fibrosi minima senza atipia ‚Üí Pre-PMF/ET', points: '-40', type: 'negative' });
            }
            
            return { score: Math.max(0, score), reasoning };
        }
        
        function calculatePrePMFScore(data) {
            let score = 0;
            let reasoning = [];
            
            if (data.megakaryocyte === 'clustered') {
                score += 30;
                reasoning.push({ text: 'Clustering megacariociti', points: '+30', type: 'positive' });
            }
            
            if (data.fibrosis === 1) {
                score += 40;
                reasoning.push({ text: '‚úì‚úì Fibrosi MINIMA MF-1 (chiave Pre-PMF)', points: '+40', type: 'positive' });
            } else if (data.fibrosis === 0) {
                score += 10;
                reasoning.push({ text: 'MF-0 con clustering', points: '+10', type: 'positive' });
            } else if (data.fibrosis >= 2) {
                score -= 50;
                reasoning.push({ text: 'Fibrosi marcata ‚Üí PMF overt', points: '-50', type: 'negative' });
            }
            
            if (data.cellularity === 'normal' || data.cellularity === 'increased') {
                score += 15;
                reasoning.push({ text: 'Cellularit√† normocellulare', points: '+15', type: 'positive' });
            }
            
            return { score: Math.max(0, score), reasoning };
        }
        
        // ============================================================================
        // RED FLAG DETECTION
        // ============================================================================
        
        function detectRedFlags(data) {
            let alerts = [];
            
            // BLASTI AUMENTATI - AML o trasformazione
            if (data.blasts_percent > 20) {
                alerts.push({
                    type: 'critical',
                    diagnosis: 'AML',
                    title: 'üö® BLASTI >20% - AML CONFERMATO',
                    message: `Blasti ${data.blasts_percent}% (criterio WHO per AML)`,
                    action: 'URGENT: Conferma diagnosi di AML. Citogenetica STAT, NGS panel (FLT3, NPM1, CEBPA, TP53)',
                    severity: 1
                });
            } else if (data.blasts_percent > 10 && data.blasts_percent <= 20) {
                alerts.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è Blasti 10-20%',
                    message: `Blasti ${data.blasts_percent}% (aumento moderato)`,
                    action: 'Monitorare: possibile trasformazione blastica in NMC. Valutare evoluzione clinica',
                    severity: 2
                });
            }
            
            // LMMC - con criterio monociti periferici
            if (data.cd68 === 'strong' && data.cd14 === 'strong' && data.cd163 === 'strong') {
                let lmmc_msg = 'CD68++ / CD14++ / CD163++ diffuso (proliferazione monocitaria)';
                let lmmc_action = 'CORRELARE con monociti periferici ASSOLUTI (>1√ó10‚Åπ/L per diagnosi LMMC)';
                
                if (data.monocytes_absolute && data.monocytes_absolute > 1) {
                    lmmc_msg += ` + Monociti periferici ${data.monocytes_absolute}√ó10‚Åπ/L`;
                    lmmc_action = '‚úì LMMC CONFERMATO (monociti >1√ó10‚Åπ/L)';
                }
                
                alerts.push({
                    type: 'critical',
                    diagnosis: 'LMMC',
                    title: data.monocytes_absolute && data.monocytes_absolute > 1 ? 'üö® LMMC CONFERMATO' : '‚ö†Ô∏è LMMC SUSPECT',
                    message: lmmc_msg,
                    action: lmmc_action,
                    severity: 1
                });
            }
            
            // AML pattern
            if ((data.mpo === 'marked' && data.cd15 === 'negative') || 
                (data.cd68 === 'strong' && data.cd14 === 'negative')) {
                alerts.push({
                    type: 'critical',
                    diagnosis: 'AML',
                    title: 'üö® AML SUSPECT',
                    message: data.mpo === 'marked' && data.cd15 === 'negative' ? 
                        'MPO marcato + CD15 negativo' : 
                        'CD68++ / CD14- pattern monoblastico',
                    action: 'URGENT: Conta blasti, CD34, CD117, citogenetica, NGS',
                    severity: 1
                });
            }
            
            // LYMPHOMA
            if (data.lymphoid_percent > 20) {
                const sev = data.lymphoid_distribution === 'sheets' ? 1 : 2;
                alerts.push({
                    type: 'critical',
                    diagnosis: 'LYMPHOMA',
                    title: sev === 1 ? 'üö® LINFOMA AGGRESSIVO' : '‚ö†Ô∏è LINFOMA MIDOLLARE',
                    message: `Componente linfoide ${data.lymphoid_percent}%${data.lymphoid_distribution === 'sheets' ? ' (pattern a tappeto)' : ''}`,
                    action: 'Citofluorimetria (CD3, CD20, CD5), IHC estesa (BCL2, BCL6), NGS TCR/IGH',
                    severity: sev
                });
            }
            
            // MYELOMA
            if (data.cd138 === 'high') {
                alerts.push({
                    type: 'critical',
                    diagnosis: 'MM',
                    title: 'üö® MYELOMA SUSPECT',
                    message: 'CD138 >10% (plasmacellule aumentate)',
                    action: 'Immunofissazione sierica/urinaria, catene leggere libere',
                    severity: 1
                });
                
                if (data.kappa_lambda === 'severe' || data.kappa_lambda === 'kappa' || data.kappa_lambda === 'lambda') {
                    alerts.push({
                        type: 'success',
                        diagnosis: 'MM_CONFIRMED',
                        title: '‚úì MULTIPLE MYELOMA CONFIRMED',
                        message: `Clonalit√† confermata: K/L ${data.kappa_lambda}`,
                        action: 'Diagnosi di mieloma multiplo - NGS panel (NRAS, KRAS, FAM46C)',
                        severity: 0
                    });
                }
            }
            
            // CML alert
            if (data.cytogenetics === 't9_22') {
                alerts.push({
                    type: 'critical',
                    title: 'üö® t(9;22) BCR/ABL',
                    message: 'Traslocazione caratteristica della CML (Leucemia Mieloide Cronica)',
                    action: 'Diagnosi: CML. Esclude NMC. Valutare fase (cronica, accelerazione, blastica)',
                    severity: 1
                });
            }
            
            // Granulocytic proliferation warning
            if (data.proliferation === 'granulocytic') {
                alerts.push({
                    type: 'warning',
                    title: '‚ö†Ô∏è Proliferazione granulocitaria',
                    message: 'Predominanza linea granulocitaria',
                    action: data.mpo === 'shift' ? 'Valutare shift a sinistra/immaturit√†' : 'Valutare rispetto alla maturazione',
                    severity: 3
                });
            }
            
            return alerts;
        }
        
        // ============================================================================
        // MAIN DIAGNOSTIC ENGINE
        // ============================================================================
        
        function analyzeCase() {
            const required = ['cellularity', 'megakaryocyte', 'proliferation', 'fibrosis'];
            for (let field of required) {
                if (!document.getElementById(field).value) {
                    alert('Compila campi obbligatori: cellularit√†, megacariociti, proliferazione, fibrosi');
                    return;
                }
            }
            
            const data = collectData();
            
            // Pattern recognition scores
            const et_result = calculateETScore(data);
            const pv_result = calculatePVScore(data);
            const pmf_result = calculatePMFScore(data);
            const pre_pmf_result = calculatePrePMFScore(data);
            
            // WHO 2022 formal criteria
            const who_pv = calculateWHOPVScore(data);
            const who_et = calculateWHOETScore(data);
            const who_pmf = calculateWHOPMFScore(data);
            
            const red_flags = detectRedFlags(data);
            
            let primary_diagnosis = null;
            
            if (red_flags.some(a => a.severity === 1)) {
                const critical_alert = red_flags.find(a => a.severity === 1);
                primary_diagnosis = {
                    type: 'alternative',
                    diagnosis: critical_alert.diagnosis,
                    confidence: 95,
                    alert: critical_alert
                };
            } else {
                const scores = [
                    { name: 'ET', score: et_result.score, details: et_result },
                    { name: 'PV', score: pv_result.score, details: pv_result },
                    { name: 'PMF', score: pmf_result.score, details: pmf_result },
                    { name: 'Pre-PMF', score: pre_pmf_result.score, details: pre_pmf_result }
                ];
                
                scores.sort((a, b) => b.score - a.score);
                const winner = scores[0];
                
                primary_diagnosis = {
                    type: 'nmc',
                    diagnosis: winner.name,
                    confidence: Math.min(winner.score, 95),
                    score: winner.score,
                    reasoning: winner.details.reasoning,
                    ddx: scores.slice(1)
                };
            }
            
            const report = generateReport(data, primary_diagnosis, red_flags, who_pv, who_et, who_pmf);
            displayResults(data, primary_diagnosis, red_flags, report, who_pv, who_et, who_pmf);
            switchTab('results');
        }
        
        function collectData() {
            return {
                biopsy_date: document.getElementById('biopsy-date').value,
                age: parseInt(document.getElementById('age').value) || null,
                sex: document.getElementById('sex').value,
                cellularity_percent: parseFloat(document.getElementById('cellularity-percent').value) || null,
                cellularity: document.getElementById('cellularity').value,
                megakaryocyte: document.getElementById('megakaryocyte').value,
                proliferation: document.getElementById('proliferation').value,
                fibrosis: parseInt(document.getElementById('fibrosis').value) || 0,
                me_ratio: document.getElementById('me_ratio').value,
                lymphoid_percent: parseFloat(document.getElementById('lymphoid-percent').value) || 0,
                lymphoid_distribution: document.getElementById('lymphoid-distribution').value,
                blasts_percent: parseFloat(document.getElementById('blasts-percent').value) || 0,
                monocytes_absolute: parseFloat(document.getElementById('monocytes-absolute').value) || null,
                morphology_notes: document.getElementById('morphology-notes').value,
                ecadherin: document.getElementById('ecadherin').value,
                mpo: document.getElementById('mpo').value,
                cd15: document.getElementById('cd15').value,
                cd68: document.getElementById('cd68').value,
                cd14: document.getElementById('cd14').value,
                cd163: document.getElementById('cd163').value,
                cd61: document.getElementById('cd61').value,
                cd3: document.getElementById('cd3').value,
                cd20: document.getElementById('cd20').value,
                cd138: document.getElementById('cd138').value,
                kappa_lambda: document.getElementById('kl_performed').checked ? document.getElementById('kappa_lambda').value : '',
                hb: parseFloat(document.getElementById('hb').value) || null,
                hct: parseFloat(document.getElementById('hct').value) || null,
                plt: parseFloat(document.getElementById('plt').value) || null,
                wbc: parseFloat(document.getElementById('wbc').value) || null,
                jak2: document.getElementById('jak2').checked,
                calr: document.getElementById('calr').checked,
                mpl: document.getElementById('mpl').checked,
                cytogenetics: document.getElementById('cytogenetics').value,
                cytogenetics_notes: document.getElementById('cytogenetics-notes').value,
                splenomegaly: document.getElementById('splenomegaly').checked,
                symptoms: document.getElementById('symptoms').checked,
                anemia: document.getElementById('anemia').checked,
                ldh_elevated: document.getElementById('ldh').value === 'elevated',
                clinical_question: document.getElementById('clinical-question').value
            };
        }
        
        function generateReport(data, diagnosis, red_flags, who_pv, who_et, who_pmf) {
            let report = `REFERTO ISTOLOGICO - BIOPSIA OSTEOMIDOLLARE\n`;
            report += `${'='.repeat(70)}\n`;
            if (data.biopsy_date) report += `DATA: ${data.biopsy_date}\n`;
            report += `${'='.repeat(70)}\n\n`;
            
            report += `CELLULARIT√Ä:\n`;
            report += `- Percentuale: ${data.cellularity_percent}% (${data.cellularity})\n`;
            report += `- Rapporto M/E: ${data.me_ratio || 'non valutato'}\n\n`;
            
            report += `ISTOLOGIA:\n`;
            report += `- Megacariociti: ${data.megakaryocyte}\n`;
            report += `- Proliferazione: ${data.proliferation}\n`;
            report += `- Fibrosi: MF-${data.fibrosis}\n`;
            report += `- Blasti: ${data.blasts_percent}%\n`;
            if (data.morphology_notes) report += `- Note morfologiche: ${data.morphology_notes}\n`;
            report += `\n`;
            
            report += `IMMUNOISTOCHIMICA:\n`;
            report += `- E-caderina: ${data.ecadherin}\n`;
            report += `- MPO: ${data.mpo} / CD15: ${data.cd15}\n`;
            report += `- CD68: ${data.cd68} / CD14: ${data.cd14} / CD163: ${data.cd163}\n`;
            report += `- CD61: ${data.cd61}\n`;
            report += `- CD3: ${data.cd3} / CD20: ${data.cd20}\n`;
            report += `- CD138: ${data.cd138}\n`;
            if (data.kappa_lambda) report += `- K/L: ${data.kappa_lambda}\n`;
            report += `\n`;
            
            report += `DATI CLINICO-LABORATORISTICI:\n`;
            if (data.hb) report += `- Hb: ${data.hb} g/dL\n`;
            if (data.hct) report += `- Hct: ${data.hct}%\n`;
            if (data.plt) report += `- Piastrine: ${data.plt}√ó10‚Åπ/L\n`;
            if (data.wbc) report += `- Leucociti: ${data.wbc}√ó10‚Åπ/L\n`;
            if (data.monocytes_absolute) report += `- Monociti periferici: ${data.monocytes_absolute}√ó10‚Åπ/L\n`;
            if (data.jak2 || data.calr || data.mpl) {
                report += `- Molecolare: `;
                let mol = [];
                if (data.jak2) mol.push('JAK2+');
                if (data.calr) mol.push('CALR+');
                if (data.mpl) mol.push('MPL+');
                report += mol.join(', ') + '\n';
            }
            if (data.cytogenetics && data.cytogenetics !== '') {
                report += `- Citogenetica: ${data.cytogenetics}`;
                if (data.cytogenetics_notes) report += ` (${data.cytogenetics_notes})`;
                report += '\n';
            }
            report += `\n`;
            
            report += `DIAGNOSI:\n`;
            if (diagnosis.type === 'nmc') {
                report += `Pattern Recognition: ${diagnosis.diagnosis} (score: ${diagnosis.score}/100)\n`;
                report += `\nCriteri WHO 2022:\n`;
                report += `- PV: ${who_pv.diagnosis} (${who_pv.summary})\n`;
                report += `- ET: ${who_et.diagnosis} (${who_et.summary})\n`;
                report += `- PMF: ${who_pmf.diagnosis} (${who_pmf.summary})\n`;
            } else {
                report += `RED FLAG CRITICO: ${diagnosis.diagnosis}\n`;
                report += `${diagnosis.alert.message}\n`;
            }
            
            return report;
        }
        
        function displayResults(data, diagnosis, red_flags, report, who_pv, who_et, who_pmf) {
            let html = `<h3>üìä Risultati Analisi</h3>`;
            
            // Red flags
            if (red_flags.length > 0) {
                red_flags.forEach(alert => {
                    const alertClass = `alert alert-${alert.type}`;
                    html += `<div class="${alertClass}">`;
                    html += `<strong>${alert.title}</strong><br>`;
                    html += `${alert.message}<br>`;
                    html += `<em>‚ûú ${alert.action}</em>`;
                    html += `</div>`;
                });
            }
            
            // WHO 2022 Formal Criteria
            html += `<h3 style="margin-top: 30px;">üß™ Criteri WHO 2022 Formali</h3>`;
            
            // PV WHO
            html += `<div class="pattern-box who-box">`;
            html += `<h4>Policitemia Vera - ${who_pv.diagnosis}</h4>`;
            html += `<p><strong>${who_pv.summary}</strong></p>`;
            html += `<p style="margin-top: 10px; font-size: 0.9em;"><em>Diagnosi richiede: ‚â•2 maggiori O 1 maggiore + 1 minore</em></p>`;
            who_pv.details.forEach(d => {
                const critClass = d.met === true ? 'who-criteria met' : 
                                 d.met === false ? 'who-criteria not-met' : 'who-criteria';
                html += `<div class="${critClass}">`;
                html += `<strong>${d.criterion}:</strong> ${d.text}`;
                html += `</div>`;
            });
            html += `</div>`;
            
            // ET WHO
            html += `<div class="pattern-box who-box">`;
            html += `<h4>Trombocitemia Essenziale - ${who_et.diagnosis}</h4>`;
            html += `<p><strong>${who_et.summary}</strong></p>`;
            html += `<p style="margin-top: 10px; font-size: 0.9em;"><em>Diagnosi richiede: TUTTI i 4 criteri</em></p>`;
            who_et.criteria.forEach(c => {
                const critClass = c.met ? 'who-criteria met' : 'who-criteria not-met';
                html += `<div class="${critClass}">`;
                html += `<strong>Criterio ${c.number}:</strong> ${c.text}`;
                html += `</div>`;
            });
            html += `</div>`;
            
            // PMF WHO
            html += `<div class="pattern-box who-box">`;
            html += `<h4>Mielofibrosi Primaria - ${who_pmf.diagnosis}</h4>`;
            html += `<p><strong>${who_pmf.summary}</strong></p>`;
            html += `<p style="margin-top: 10px; font-size: 0.9em;"><em>Diagnosi richiede: ‚â•3 maggiori + ‚â•1 minore</em></p>`;
            html += `<p style="margin-top: 10px;"><strong>Criteri Maggiori:</strong></p>`;
            who_pmf.majorCriteria.forEach(c => {
                const critClass = c.met ? 'who-criteria met' : 'who-criteria not-met';
                html += `<div class="${critClass}">`;
                html += `<strong>Maggiore ${c.number}:</strong> ${c.text}`;
                html += `</div>`;
            });
            html += `<p style="margin-top: 15px;"><strong>Criteri Minori:</strong></p>`;
            who_pmf.minorCriteria.forEach(c => {
                const critClass = c.met === true ? 'who-criteria met' : 
                                 c.met === false ? 'who-criteria not-met' : 'who-criteria';
                html += `<div class="${critClass}">`;
                html += `<strong>Minore ${c.number}:</strong> ${c.text}`;
                html += `</div>`;
            });
            html += `</div>`;
            
            // Pattern Recognition
            html += `<h3 style="margin-top: 30px;">üî¨ Pattern Recognition (Scoring Euristico)</h3>`;
            if (diagnosis.type === 'nmc') {
                html += `<div class="pattern-box">`;
                html += `<h4>${diagnosis.diagnosis}</h4>`;
                html += `<div class="confidence-meter">`;
                const bars = Math.round(diagnosis.score / 20);
                for (let i = 0; i < 5; i++) {
                    html += `<div class="confidence-bar ${i < bars ? 'filled' : ''}"></div>`;
                }
                html += `</div>`;
                html += `<p style="font-weight: bold; color: #667eea;">Score: ${diagnosis.score}/100 (Confidenza: ${diagnosis.confidence}%)</p>`;
                
                if (diagnosis.reasoning && diagnosis.reasoning.length > 0) {
                    html += `<h5 style="margin-top: 15px; color: #333;">Razionamento:</h5>`;
                    diagnosis.reasoning.forEach(r => {
                        const scoreClass = r.type === 'positive' ? 'scoring-positive' : 'scoring-negative';
                        html += `<div class="scoring-detail ${scoreClass}">`;
                        html += `${r.text} <strong>${r.points}</strong>`;
                        html += `</div>`;
                    });
                }
                
                if (diagnosis.ddx && diagnosis.ddx.length > 0) {
                    html += `<h5 style="margin-top: 15px; color: #333;">Diagnosi Differenziale:</h5>`;
                    diagnosis.ddx.forEach(d => {
                        html += `<div style="background: #fff3cd; padding: 10px; margin: 8px 0; border-radius: 5px;">`;
                        html += `<strong>${d.name}</strong> (score: ${d.score})`;
                        html += `</div>`;
                    });
                }
                html += `</div>`;
            }
            
            // Report
            html += `<h4 style="margin-top: 20px;">üìÑ Referto</h4>`;
            html += `<div class="report-text">${report}</div>`;
            html += `<button class="copy-btn" onclick="copyToClipboard()">üìã Copia Referto</button>`;
            
            document.getElementById('result-area').innerHTML = html;
        }
        
        function copyToClipboard() {
            const text = document.querySelector('.report-text').textContent;
            navigator.clipboard.writeText(text).then(() => alert('‚úÖ Referto copiato'));
        }
        
        function resetForm() {
            document.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.type === 'checkbox') el.checked = false;
                else if (el.tagName === 'SELECT') el.selectedIndex = 0;
                else el.value = '';
            });
            document.getElementById('kappa_lambda').style.display = 'none';
            document.getElementById('result-area').innerHTML = '';
        }
    </script>
</body>
</html>
